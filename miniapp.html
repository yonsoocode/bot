<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MagicDrop - NFT Gift Cases</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Exo+2:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e);
            --card-bg: rgba(25, 25, 45, 0.85);
            --primary: #4e54c8;
            --primary-dark: #3a3f9e;
            --secondary: #6a67ce;
            --accent: #ff6b6b;
            --stars: #ffd700; /* Цвет для TON */
            --ton: #0099ff; /* Основной цвет TON */
            --rare: #4fc3f7;
            --epic: #ce93d8;
            --legendary: #ffd700;
            --uncommon: #81c784;
            --common: #bdbdbd;
            --glass-bg: rgba(40, 40, 65, 0.4);
            --glass-border: rgba(78, 84, 200, 0.2);
            --glow-primary: 0 0 20px rgba(78, 84, 200, 0.6);
            --glow-secondary: 0 0 25px rgba(106, 103, 206, 0.4);
            --text-primary: #ffffff;
            --text-secondary: #d8d7ff;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Exo 2', sans-serif;
        }
        h1, h2, h3, .logo-text h1, .section-title, .modal-title, .case-name, .item-name {
            font-family: 'Orbitron', sans-serif;
        }
        body {
            background: #000000;
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px 20px 80px;
            background-attachment: fixed;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Звезды на фоне */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite ease-in-out;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #ffffff, transparent),
                radial-gradient(2px 2px at 40px 70px, #ffffff, transparent),
                radial-gradient(1px 1px at 90px 40px, #ffffff, transparent),
                radial-gradient(1px 1px at 130px 80px, #ffffff, transparent),
                radial-gradient(2px 2px at 160px 30px, #ffffff, transparent);
            background-repeat: repeat;
            background-size: 200px 100px;
            animation: sparkle 3s linear infinite;
            pointer-events: none;
            z-index: 1;
        }
        
        @keyframes sparkle {
            0%, 100% { 
                opacity: 0.6;
                background-position: 0 0;
            }
            50% { 
                opacity: 1;
                background-position: 10px 5px;
            }
        }
        
        html {
            scroll-behavior: smooth;
        }
        @media (prefers-reduced-motion: reduce) {
            html {
                scroll-behavior: auto;
            }
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--glass-border);
            margin-bottom: 40px;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--glow-primary);
            transition: all 0.3s ease;
        }
        .logo-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 0 25px rgba(78, 84, 200, 0.8);
        }
        .logo-text h1 {
            font-size: 2rem;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
        }
        .logo-text p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .balance-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .balance {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        .balance:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(78, 84, 200, 0.4);
        }
        .balance i {
            color: var(--ton); /* Изменил на TON */
            font-size: 1.2rem;
        }
        .balance span {
            font-weight: 600;
            font-size: 1.1rem;
        }
        .top-up-btn {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(78, 84, 200, 0.3);
        }
        .top-up-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(78, 84, 200, 0.5);
        }
        .section-title {
            font-size: 2.2rem;
            margin: 30px 0 20px;
            position: relative;
            padding-bottom: 10px;
            font-weight: 700;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 2px;
        }
        .cases-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
        }
        .case-card {
            width: 320px;
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        .case-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(78, 84, 200, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
        }
        .case-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            border-color: rgba(78, 84, 200, 0.5);
        }
        .case-card:hover::before {
            opacity: 1;
        }
        .case-image {
            width: 180px;
            height: 180px;
            margin: 0 auto 25px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            position: relative;
            border: 3px solid var(--glass-border);
        }
        .case-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }
        .case-card:hover .case-image img {
            transform: scale(1.05);
        }
        .case-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        .case-desc {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        .case-price {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--ton); /* Изменил на TON */
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .case-price i {
            font-size: 1.2rem;
        }
        .spin-btn {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(78, 84, 200, 0.3);
        }
        .spin-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(78, 84, 200, 0.5);
        }
        .spin-btn:active {
            transform: translateY(0);
        }
        .spin-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        .spin-btn:hover::before {
            left: 100%;
        }
        .result-container {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 40px;
            margin: 50px 0;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--glass-border);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        .result-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        .rolling {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        .spinner-container {
            width: 100%;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 30px;
            overflow: hidden;
        }
        .spinner-track {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            position: relative;
            perspective: 1000px;
        }
        /* Horizontal reel spinner - EXACT DESIGN */
        .wheel {
            position: relative;
            width: 100%;
            height: 180px;
            border-radius: 20px;
            will-change: transform;
            transform: translate3d(0, 0, 0);
            border: 2px solid rgba(78, 84, 200, 0.3);
            box-shadow: 
                0 0 30px rgba(78, 84, 200, 0.2),
                inset 0 0 20px rgba(78, 84, 200, 0.1);
            background: linear-gradient(135deg, 
                rgba(20, 20, 40, 0.9) 0%, 
                rgba(30, 30, 50, 0.8) 50%, 
                rgba(20, 20, 40, 0.9) 100%);
            overflow: hidden;
            backdrop-filter: blur(15px);
        }
        
        @keyframes wheelGlow {
            0%, 100% {
                box-shadow: 
                    0 0 30px rgba(78, 84, 200, 0.3),
                    inset 0 0 30px rgba(78, 84, 200, 0.1);
            }
            50% {
                box-shadow: 
                    0 0 40px rgba(78, 84, 200, 0.5),
                    inset 0 0 40px rgba(78, 84, 200, 0.2);
            }
        }
        .wheel-item {
            position: absolute;
            top: 50%;
            left: 0;
            width: 140px;
            height: 140px;
            margin: -70px 0 0 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.4),
                0 0 6px rgba(78, 84, 200, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .wheel-item.gold-bg {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        }
        
        .wheel-item.purple-bg {
            background: linear-gradient(135deg, #8A2BE2 0%, #9932CC 100%);
        }
        
        .wheel-item.blue-bg {
            background: linear-gradient(135deg, #4169E1 0%, #1E90FF 100%);
        }
        
        .wheel-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.3) 2px, transparent 2px),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.2) 1px, transparent 1px);
            background-size: 20px 20px, 15px 15px;
            pointer-events: none;
        }
        
        .wheel-item.blue-bg::before {
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.4) 3px, transparent 3px),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.3) 2px, transparent 2px);
            background-size: 25px 25px, 20px 20px;
        }
        .wheel-item:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 
                0 12px 25px rgba(0, 0, 0, 0.5),
                0 0 15px rgba(78, 84, 200, 0.5);
        }
        .wheel-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
            user-select: none;
            pointer-events: none;
        }
        .spinner-indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            width: 3px;
            height: 160px;
            transform: translateX(-50%);
            background: linear-gradient(180deg, 
                transparent 0%, 
                rgba(138, 43, 226, 0.3) 15%, 
                rgba(138, 43, 226, 0.8) 40%, 
                rgba(255, 20, 147, 1) 50%, 
                rgba(138, 43, 226, 0.8) 60%, 
                rgba(138, 43, 226, 0.3) 85%, 
                transparent 100%);
            box-shadow: 
                0 0 20px rgba(138, 43, 226, 0.6),
                0 0 40px rgba(255, 20, 147, 0.3);
            border-radius: 2px;
            pointer-events: none;
            z-index: 20;
            animation: indicatorPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes indicatorPulse {
            0%, 100% { 
                opacity: 1;
                transform: translateX(-50%) scaleY(1);
            }
            50% { 
                opacity: 0.7;
                transform: translateX(-50%) scaleY(1.1);
            }
        }
        
        /* Additional wheel effects */
        .wheel::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                transparent 0deg,
                rgba(78, 84, 200, 0.3) 45deg,
                rgba(255, 107, 107, 0.3) 90deg,
                rgba(78, 84, 200, 0.3) 135deg,
                transparent 180deg,
                transparent 360deg
            );
            animation: wheelRotate 4s linear infinite;
            z-index: -1;
        }
        
        @keyframes wheelRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .wheel::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, var(--accent) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.6);
            animation: centerGlow 2s ease-in-out infinite;
        }
        
        @keyframes centerGlow {
            0%, 100% { 
                opacity: 0.8;
                transform: translate(-50%, -50%) scale(1);
            }
            50% { 
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
        }
        
        /* Upgrade wheel specific styles */
        .upgrade-wheel-container {
            margin: 30px 0;
            padding: 40px 20px;
            background: var(--card-bg);
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid var(--glass-border);
            min-height: 400px;
        }
        /* Стили для круга со стрелкой */
        .wheel-wrapper {
            position: relative;
            width: 300px;
            height: 300px;
        }
        .wheel-circle {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                #4CAF50 0% var(--win-percent, 50%),
                #ff4444 var(--win-percent, 50%) 100%
            );
            /* Плавное замедление: cubic-bezier(0.2, 0.8, 0.3, 1) */
            transition: transform 4.5s cubic-bezier(0.2, 0.8, 0.3, 1); 
            transform: rotate(0deg);
        }
        .wheel-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: var(--card-bg);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2;
            border: 2px solid var(--glass-border);
        }
        .wheel-center-text {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-primary);
        }
        .wheel-center-percent {
            font-size: 14px;
            color: var(--text-secondary);
        }
        /* СКРЫВАЕМ результат из центра */
        .wheel-center-result {
            display: none;
        }
        .wheel-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 20px solid #fff;
            z-index: 3;
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));
        }
        /* Новая горизонтальная анимация прокрутки */
        .reel-container {
            width: 100%;
            max-width: 90vw;
            overflow: hidden;
            position: relative;
            padding: 20px 0;
            height: 200px;
            display: flex;
            align-items: center;
        }

        /* Индикатор в центре - как на фото */
        .indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 3px;
            height: 160px;
            background: linear-gradient(to bottom, 
                transparent 0%, 
                #8A2BE2 20%, 
                #8A2BE2 80%, 
                transparent 100%);
            z-index: 10;
            box-shadow: 0 0 10px rgba(138, 43, 226, 0.8);
            border-radius: 2px;
        }

        @keyframes indicatorPulse {
            0%, 100% { 
                opacity: 1;
                transform: translate(-50%, -50%) scaleY(1);
            }
            50% { 
                opacity: 0.8;
                transform: translate(-50%, -50%) scaleY(1.1);
            }
        }

        /* Лента с элементами */
        .reel-strip {
            display: flex;
            align-items: center;
            gap: 10px;
            will-change: transform;
            transform: translate3d(0, 0, 0);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Элементы барабана - прозрачные на звездном фоне */
        .reel-item {
            flex: 0 0 120px;
            width: 120px;
            height: 160px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        /* Убираем специфичные фоны - все элементы прозрачные */
        .reel-item.purple-bg,
        .reel-item.gold-bg,
        .reel-item.blue-bg,
        .reel-item.red-bg {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .reel-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(78, 84, 200, 0.1) 0%, 
                transparent 30%, 
                transparent 70%, 
                rgba(106, 103, 206, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .reel-item:hover {
            transform: scale(1.05) translateY(-5px);
            box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.6),
                0 0 0 1px rgba(78, 84, 200, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .reel-item:hover::before {
            opacity: 1;
        }

        .item-image {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: #fff;
            margin-top: 5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            position: relative;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .item-image .fallback-icon {
            font-size: 2.5rem;
        }

        .item-price {
            font-size: 1rem;
            font-weight: 700;
            color: #00ccff;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            background: rgba(0, 0, 0, 0.4);
            padding: 4px 8px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 204, 255, 0.3);
            text-shadow: 0 0 10px rgba(0, 204, 255, 0.5);
        }

        .item-icon {
            font-size: 0.7rem;
        }

        /* Кнопка пропуска */
        .skip-button {
            margin-top: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 15px 25px;
            background: rgba(25, 25, 45, 0.8);
            border-radius: 20px;
            border: 1px solid rgba(78, 84, 200, 0.3);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .skip-button:hover {
            background: rgba(78, 84, 200, 0.2);
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(78, 84, 200, 0.4);
        }

        .skip-icon {
            font-size: 2.5rem;
            animation: bounce 1.5s infinite;
            text-shadow: 0 0 20px rgba(78, 84, 200, 0.6);
        }

        @keyframes bounce {
            0%, 100% { 
                transform: translateY(0) scale(1);
            }
            50% { 
                transform: translateY(-15px) scale(1.1);
            }
        }

        .skip-text {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 600;
            text-shadow: 0 0 10px rgba(78, 84, 200, 0.5);
        }

        /* Анимация прокрутки с плавным замедлением */
        .reel-strip.animating {
            transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .reel-strip.slow-down {
            transition: transform 2s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        /* Стили для активного элемента (под индикатором) */
        .reel-item.active {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            box-shadow: 
                0 0 30px rgba(255, 255, 255, 0.3),
                0 0 60px rgba(255, 255, 255, 0.1),
                0 15px 40px rgba(0, 0, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transform: scale(1.15) translateY(-8px);
            z-index: 5;
            border-color: rgba(255, 255, 255, 0.3);
            animation: activeGlow 1.5s ease-in-out infinite;
        }

        @keyframes activeGlow {
            0%, 100% { 
                box-shadow: 
                    0 0 30px rgba(255, 255, 255, 0.3),
                    0 0 60px rgba(255, 255, 255, 0.1),
                    0 15px 40px rgba(0, 0, 0, 0.6),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }
            50% { 
                box-shadow: 
                    0 0 40px rgba(255, 255, 255, 0.5),
                    0 0 80px rgba(255, 255, 255, 0.2),
                    0 20px 50px rgba(0, 0, 0, 0.7),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4);
            }
        }

        /* Стили для элементов слева и справа от активного */
        .reel-item.left {
            transform: translateX(-30%) scale(0.85) rotateY(15deg);
            opacity: 0.6;
            filter: blur(1px);
        }

        .reel-item.right {
            transform: translateX(30%) scale(0.85) rotateY(-15deg);
            opacity: 0.6;
            filter: blur(1px);
        }

        /* Стили для страницы кручения */
        .spin-page-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: #000000;
            position: relative;
            overflow: hidden;
        }

        .spin-page-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(78, 84, 200, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(106, 103, 206, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(255, 107, 107, 0.05) 0%, transparent 50%);
            animation: backgroundShift 10s ease-in-out infinite;
        }

        @keyframes backgroundShift {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .spin-page-container .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            background: rgba(25, 25, 45, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(78, 84, 200, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .spin-page-container .back-btn:hover {
            background: rgba(78, 84, 200, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(78, 84, 200, 0.4);
        }

        .spin-page-container .section-title {
            margin-bottom: 40px;
            text-align: center;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #4e54c8, #6a67ce, #ff6b6b, #4e54c8);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: gradientShift 3s ease-in-out infinite;
            text-shadow: 0 0 30px rgba(78, 84, 200, 0.5);
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .spin-page-container .result-container {
            width: 100%;
            max-width: 90vw;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .spinner-item {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            transition: transform 0.18s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.18s ease;
            opacity: 0.7;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid transparent;
            transform-style: preserve-3d;
            will-change: transform, opacity;
        }
        .spinner-item.active {
            width: 250px;
            height: 250px;
            opacity: 1;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            transform: scale(1.1) rotateY(0deg);
            z-index: 10;
            border-color: var(--primary);
            animation: spin-center 1s ease-in-out infinite;
        }
        .spinner-item.left {
            transform: translateX(-110%) scale(0.8) rotateY(20deg);
            opacity: 0.7;
            z-index: 5;
        }
        .spinner-item.right {
            transform: translateX(110%) scale(0.8) rotateY(-20deg);
            opacity: 0.7;
            z-index: 5;
        }
        @keyframes spin-center {
            0% { transform: scale(1.1) rotateY(0deg); }
            50% { transform: scale(1.1) rotateY(10deg); }
            100% { transform: scale(1.1) rotateY(0deg); }
        }
        .spinner-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 15px;
        }
        .item-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding: 20px;
        }
        .item-image {
            width: 300px;
            height: 300px;
            object-fit: cover;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            border: 3px solid var(--glass-border);
            transition: all 0.3s ease;
            position: relative;
        }
        .item-display:hover .item-image {
            transform: scale(1.03);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }
        .item-info {
            text-align: center;
            width: 100%;
            background: rgba(20, 20, 35, 0.5);
            padding: 25px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }
        .item-name {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: white;
        }
        .item-meta {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }
        .item-property {
            background: var(--glass-bg);
            padding: 12px 20px;
            border-radius: 15px;
            font-size: 0.95rem;
            border: 1px solid var(--glass-border);
            min-width: 180px;
            text-align: center;
        }
        .item-property span:first-child {
            color: var(--text-secondary);
            font-size: 0.9rem;
            display: block;
            margin-bottom: 5px;
        }
        .rarity {
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1rem;
            display: inline-block;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .rarity.common { background: var(--common); color: #000; }
        .rarity.uncommon { background: var(--uncommon); color: #000; }
        .rarity.rare { background: var(--rare); }
        .rarity.epic { background: var(--epic); }
        .rarity.legendary { background: var(--legendary); color: #000; }
        .item-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--ton); /* Изменил на TON */
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .claim-btn {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 18px 45px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(78, 84, 200, 0.3);
        }
        .claim-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(78, 84, 200, 0.5);
        }
        .history-container {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 35px;
            margin: 50px 0;
            border: 1px solid var(--glass-border);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        .history-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        .history-item {
            background: var(--glass-bg);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
        }
        .history-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border-color: rgba(78, 84, 200, 0.4);
        }
        .history-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid var(--glass-border);
        }
        .history-name {
            font-weight: 600;
            font-size: 1rem;
            text-align: center;
            margin-bottom: 5px;
        }
        .history-meta {
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 0.9rem;
            padding: 0 10px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 25px;
            opacity: 0.3;
            background: var(--glass-bg);
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal.active {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 40px;
            width: 100%;
            max-width: 500px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            position: relative;
            animation: modalIn 0.3s ease;
            backdrop-filter: blur(10px);
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s ease;
        }
        .modal.active .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        @keyframes modalIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--glass-bg);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .close-modal:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }
        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 30px;
            text-align: center;
            color: var(--primary);
        }
        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }
        .payment-option {
            background: var(--glass-bg);
            border-radius: 15px;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .payment-option:hover {
            background: rgba(78, 84, 200, 0.1);
            transform: translateY(-3px);
        }
        .payment-option.selected {
            border-color: var(--primary);
            background: rgba(78, 84, 200, 0.15);
        }
        .payment-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        .stars-icon { /* Переименовал класс, но оставил для TON */
            background: linear-gradient(45deg, var(--ton), #00ccff); /* Цвет TON */
            color: white;
        }
        .ton-icon { /* Новый класс для TON */
            background: linear-gradient(45deg, var(--ton), #00ccff);
            color: white;
        }
        .telegram-icon {
            background: linear-gradient(45deg, #0088cc, #00acee);
            color: white;
        }
        .payment-info {
            flex: 1;
        }
        .payment-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .payment-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .amount-input {
            width: 100%;
            padding: 15px 20px;
            border-radius: 15px;
            border: 2px solid var(--glass-border);
            background: var(--glass-bg);
            color: white;
            font-size: 1.2rem;
            margin-bottom: 30px;
            outline: none;
            transition: all 0.3s ease;
        }
        .amount-input:focus {
            border-color: var(--primary);
            background: rgba(78, 84, 200, 0.1);
        }
        .confirm-btn {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 18px 0;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }
        .confirm-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(78, 84, 200, 0.5);
        }
        .case-details {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* Animation for spinning items */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .floating {
            animation: float 3s ease-in-out infinite;
        }
        /* New styles for improved design */
        .back-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 12px 25px;
            border-radius: 50px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 30px;
        }
        .back-btn:hover {
            background: rgba(78, 84, 200, 0.2);
            transform: translateY(-2px);
        }
        .ton-address {
            background: var(--glass-bg);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.9rem;
            word-break: break-all;
            border: 1px solid var(--glass-border);
        }
        .ton-address-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            z-index: 2000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            border-left: 4px solid var(--primary);
        }
        .toast.show {
            transform: translateX(0);
        }
        /* Particles for legendary items */
        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
        }
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--card-bg);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }
        .nav-item {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: color 0.3s ease;
        }
        .nav-item.active {
            color: var(--primary);
        }
        .nav-item i {
            font-size: 1.2rem;
        }
        /* Upgrade Section */
        .upgrade-container {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 35px;
            margin: 50px 0;
            border: 1px solid var(--glass-border);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        .upgrade-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .upgrade-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .upgrade-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary);
        }
        .upgrade-select {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 15px;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }
        .upgrade-select:focus {
            border-color: var(--primary);
        }
        .upgrade-info {
            background: var(--glass-bg);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
        }
        .upgrade-chance {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--ton); /* Изменил на TON */
            margin: 10px 0;
        }
        .upgrade-cost {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        .upgrade-btn {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }
        .upgrade-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(78, 84, 200, 0.5);
        }
        /* Inventory Section */
        .inventory-container {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 35px;
            margin: 50px 0;
            border: 1px solid var(--glass-border);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .inventory-item {
            background: var(--glass-bg);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .inventory-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border-color: rgba(78, 84, 200, 0.4);
        }
        .inventory-item.selected {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(78, 84, 200, 0.5);
        }
        .inventory-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        .inventory-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .inventory-rarity {
            font-size: 0.8rem;
            padding: 3px 10px;
            border-radius: 20px;
            display: inline-block;
        }
        /* Rating Section */
        .rating-container {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 35px;
            margin: 50px 0;
            border: 1px solid var(--glass-border);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        .rating-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .rating-table th, .rating-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
        }
        .rating-table th {
            color: var(--primary);
            font-weight: 600;
        }
        .rating-table tr:hover {
            background: rgba(78, 84, 200, 0.1);
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            vertical-align: middle;
        }
        /* Profile Section */
        .profile-container {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 35px;
            margin: 50px 0;
            border: 1px solid var(--glass-border);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            text-align: center;
        }
        /* History Section */
        .operations-history {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 35px;
            margin: 50px 0;
            border: 1px solid var(--glass-border);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        .operation-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        .operation-type {
            font-weight: 600;
            color: var(--primary);
        }
        .operation-details {
            color: var(--text-secondary);
        }
        .operation-date {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        /* Page sections */
        .page-section {
            display: none;
        }
        .page-section.active {
            display: block;
        }
        /* Стили для хлопушки и Win */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f00;
            z-index: 9999;
        }
        .win-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: bold;
            color: gold;
            z-index: 10000;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            animation: winPulse 1s ease-out;
        }
        @keyframes winPulse {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }

        /* Стили для спиннера апгрейда */
        .upgrade-spinner-container {
            width: 400px;
            height: 400px;
            position: relative;
            margin: 20px auto;
        }

        /* Стили для промокода */
        .promo-section {
            background: var(--glass-bg);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid var(--glass-border);
        }
        .promo-input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: var(--card-bg);
            color: white;
            font-size: 1rem;
            margin-bottom: 15px;
            outline: none;
        }
        .promo-btn {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }
        .promo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 84, 200, 0.4);
        }

        /* Стили для профиля */
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .stat-card {
            background: var(--glass-bg);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--glass-border);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--ton);
            margin: 10px 0;
        }
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Стили для реф. программы */
        .ref-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .ref-stat-card {
            background: var(--glass-bg);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--glass-border);
        }
        .ref-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--ton);
            margin: 5px 0;
        }
        .ref-stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        .ref-code-section {
            background: var(--glass-bg);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            border: 1px solid var(--glass-border);
        }
        .ref-link {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 12px 15px;
            margin-top: 15px;
            font-size: 0.9rem;
            word-break: break-all;
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
        }
        .ref-link-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        /* Новые стили для апгрейда */
        .win-message-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            animation: fadeOut 1s forwards;
        }
        
        .win-message-overlay.show {
            display: flex;
        }
        
        .win-text {
            font-size: 6rem;
            font-weight: bold;
            color: gold;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 215, 0, 0.5);
            animation: winPulse 1s ease-out forwards;
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; display: none; }
        }
        
        .upgrade-main-container {
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .upgrade-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .upgrade-header h2 {
            font-size: 1.8rem;
            color: var(--primary);
        }
        
        .upgrade-icons-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .upgrade-icon-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 15px;
            border-radius: 15px;
            background: var(--glass-bg);
            border: 2px solid transparent;
        }
        
        .upgrade-icon-box.active {
            border-color: var(--primary);
            background: rgba(78, 84, 200, 0.2);
        }
        
        .icon-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .upgrade-icon-box span {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .selected-gifts-upgrade {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .selected-upgrade-gift {
            background: var(--glass-bg);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 2px solid var(--glass-border);
        }
        
        .selected-upgrade-gift img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .selected-gift-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .selected-gift-stars {
            color: #ffd700;
            font-weight: bold;
        }
        
        .cancel-gift-btn {
            margin-top: 10px;
            padding: 8px 15px;
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            border: 1px solid #ff4444;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .cancel-gift-btn:hover {
            background: rgba(255, 68, 68, 0.3);
        }
        
        .upgrade-button-final {
            width: 100%;
            padding: 20px;
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .upgrade-button-final:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
        }
        
        .upgrade-wheel-container {
            margin: 30px 0;
            padding: 40px 20px;
            background: var(--card-bg);
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid var(--glass-border);
            min-height: 400px;
        }
        
        .upgrade-wheel-wrapper {
            position: relative;
            width: 100%;
            height: 160px;
            border: 2px solid #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }
        
        .wheel-pointer {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 100%;
            background: #10b981;
            z-index: 10;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.8);
        }
        
        .upgrade-wheel-strip {
            display: flex;
            gap: 20px;
            white-space: nowrap;
            transform: translateX(0);
            transition: transform 0s linear;
        }
        
        .upgrade-gift {
            width: 120px;
            height: 120px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 12px rgba(255,255,255,0.2);
            position: relative;
            flex-shrink: 0;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .upgrade-gift img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .all-gifts-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .all-gifts-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .all-gifts-modal-header h3 {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .close-modal-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid #ff4444;
            color: #ff4444;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .close-modal-btn:hover {
            background: rgba(255, 68, 68, 0.3);
        }
        
        .all-gifts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
        }
        
        .gift-modal-item {
            background: var(--glass-bg);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .gift-modal-item:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
        }
        
        .gift-modal-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .gift-modal-item-name {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .gift-modal-item-price {
            color: #ffd700;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .gift-modal-item-chance {
            color: #10b981;
            font-size: 0.85rem;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
            header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            .balance-container {
                justify-content: center;
            }
            .case-card {
                width: 100%;
                max-width: 350px;
            }
            .item-image {
                width: 250px;
                height: 250px;
            }
            .item-name {
                font-size: 1.5rem;
            }
            .history-list {
                grid-template-columns: 1fr;
            }
            .spinner-item {
                width: 150px;
                height: 150px;
            }
            .spinner-item.active {
                width: 180px;
                height: 180px;
            }
            .spinner-item.left {
                transform: translateX(-90%) scale(0.8) rotateY(20deg);
            }
            .spinner-item.right {
                transform: translateX(90%) scale(0.8) rotateY(-20deg);
            }
            .upgrade-form {
                grid-template-columns: 1fr;
            }
            .inventory-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            .bottom-nav {
                padding: 8px 0;
            }
            .nav-item {
                font-size: 0.8rem;
            }
            .nav-item i {
                font-size: 1rem;
            }
        }

        /* New Spin System Styles */
        .spin-system-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .spin-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .spin-header h2 {
            color: white;
            margin-bottom: 10px;
        }

        .spin-balance {
            color: #4e54c8;
            font-size: 18px;
            font-weight: bold;
        }

        .selected-gifts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .selected-gift-box {
            background: #1a1a1a;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .selected-gift-box h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .gift-display {
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #374151;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .gift-display.has-gift {
            border: 2px solid #4e54c8;
            background: rgba(78, 84, 200, 0.1);
        }

        .empty-gift {
            color: #9ca3af;
            font-size: 14px;
        }

        .selected-gift {
            text-align: center;
        }

        .selected-gift .gift-emoji {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .selected-gift .gift-name {
            color: white;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .selected-gift .gift-price {
            color: #4e54c8;
            font-size: 14px;
        }

        .spin-reel-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .spin-reel-wrapper {
            position: relative;
            width: 100%;
            height: 200px;
            margin: 0 auto 20px;
            overflow: hidden;
            border-radius: 15px;
            background: #1a1a1a;
            border: 2px solid #374151;
        }

        .spin-indicator {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, #4e54c8, #8b5cf6);
            z-index: 10;
            box-shadow: 0 0 10px rgba(78, 84, 200, 0.8);
        }

        .success-zone {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            border-radius: 10px;
            z-index: 5;
            transition: all 0.3s ease;
            opacity: 0;
        }

        .success-zone.visible {
            opacity: 1;
        }

        .spin-reel {
            display: flex;
            height: 100%;
            transition: transform 0.1s linear;
            will-change: transform;
        }

        .gift-card {
            min-width: 150px;
            height: 100%;
            margin-right: 10px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .gift-card.golden {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
        }

        .gift-card.blue {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .gift-card.purple {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
        }

        .gift-card.green {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .gift-card.red {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
        }

        .gift-card .gift-image {
            font-size: 40px;
            margin-bottom: 10px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .gift-card .gift-value {
            color: white;
            font-weight: bold;
            font-size: 16px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .gift-card .gift-currency {
            color: white;
            font-size: 12px;
            opacity: 0.8;
        }

        .skip-button-container {
            margin-top: 15px;
        }

        .skip-button {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .skip-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .spin-info {
            display: flex;
            justify-content: space-between;
            max-width: 300px;
            margin: 0 auto;
        }

        .chance-display, .cost-display {
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        .chance-display span {
            color: #4e54c8;
        }

        .cost-display span {
            color: #fbbf24;
        }

        .spin-button {
            width: 100%;
            background: #4e54c8;
            color: white;
            border: none;
            border-radius: 15px;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }

        .spin-button:hover:not(:disabled) {
            background: #3a3f9e;
            transform: translateY(-2px);
        }

        .spin-button:disabled {
            background: #374151;
            color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .gift-selection-container {
            margin-bottom: 30px;
        }

        .selection-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 15px;
            overflow: hidden;
            background: #1a1a1a;
        }

        .tab-button {
            flex: 1;
            padding: 12px;
            background: transparent;
            color: #9ca3af;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: bold;
        }

        .tab-button.active {
            background: #4e54c8;
            color: white;
        }

        .gifts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .gift-item {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .gift-item:hover {
            border-color: #4e54c8;
            transform: translateY(-2px);
        }

        .gift-item.selected {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }

        .gift-item .gift-emoji {
            font-size: 30px;
            margin-bottom: 8px;
        }

        .gift-item .gift-name {
            color: white;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .gift-item .gift-price {
            color: #4e54c8;
            font-size: 11px;
        }

        .test-gifts-container {
            text-align: center;
        }

        .test-button {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .test-button:hover {
            background: #059669;
        }

        /* Spinning animation */
        .spin-wheel.spinning {
            animation: spin 3s ease-out;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(1800deg); }
        }

        /* Стили для колеса подарков из кручениее.html */
        .gift {
            width: 120px;
            height: 120px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 0 12px rgba(255,255,255,0.2);
            position: relative;
            flex-shrink: 0;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .gift img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ton-label {
            display: none; /* Скрываем цену */
        }
    </style>
</head>
<body>
    <!-- Звезды на фоне -->
    <div class="stars" id="stars"></div>
    
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-bear"></i>
                </div>
                <div class="logo-text">
                    <h1>MagicDrop</h1>
                    <p>NFT Gift Cases</p>
                </div>
            </div>
            <div class="balance-container">
                <div class="balance">
                    <i class="fas fa-coins"></i> <!-- Иконка для TON -->
                    <span id="balance">50</span> <!-- Стартовый баланс в TON -->
                </div>
                <button class="top-up-btn" id="topUpBtn">
                    <i class="fas fa-plus"></i>
                    Пополнить
                </button>
            </div>
        </header>
        <!-- Main Page -->
        <div id="main-page" class="page-section active">
            <h2 class="section-title">Выберите кейс</h2>
            <div class="cases-container">
                <!-- Existing Cases -->
                <div class="case-card" data-case="start">
                    <div class="case-image">
                        <img src="https://nft.fragment.com/gift/joyfulbundle-10953.medium.jpg" alt="Start Case">
                    </div>
                    <div class="case-name">Start Case</div>
                    <div class="case-desc">Содержит случайные NFT подарки с разной редкостью и стоимостью</div>
                    <div class="case-price">
                        <i class="fas fa-coins"></i> <!-- Иконка для TON -->
                        1 TON
                    </div>
                    <button class="spin-btn">
                        <i class="fas fa-sync-alt"></i>
                        Крутить
                    </button>
                </div>
                <div class="case-card" data-case="magic">
                    <div class="case-image">
                        <img src="https://nft.fragment.com/gift/berrybox-1337.medium.jpg" alt="Magic Gift Case">
                    </div>
                    <div class="case-name">Magic Gift Case</div>
                    <div class="case-desc">Содержит редкие и легендарные NFT подарки</div>
                    <div class="case-price">
                        <i class="fas fa-coins"></i> <!-- Иконка для TON -->
                        30 TON
                    </div>
                    <button class="spin-btn">
                        <i class="fas fa-sync-alt"></i>
                        Крутить
                    </button>
                </div>
                <!-- New Cases -->
                <div class="case-card" data-case="mystic">
                    <div class="case-image">
                        <img src="https://nft.fragment.com/gift/lootbag-7631.medium.jpg" alt="Mystic Vault Case">
                    </div>
                    <div class="case-name">Mystic Vault Case</div>
                    <div class="case-desc">Загадочный сундук, полный тайн.</div>
                    <div class="case-price">
                        <i class="fas fa-coins"></i> <!-- Иконка для TON -->
                        400 TON
                    </div>
                    <button class="spin-btn">
                        <i class="fas fa-sync-alt"></i>
                        Крутить
                    </button>
                </div>
                <div class="case-card" data-case="eternal">
                    <div class="case-image">
                        <img src="https://nft.fragment.com/gift/heartlocket-875.medium.jpg" alt="Eternal Case">
                    </div>
                    <div class="case-name">Eternal Case</div>
                    <div class="case-desc">Бесконечные возможности внутри.</div>
                    <div class="case-price">
                        <i class="fas fa-coins"></i> <!-- Иконка для TON -->
                        30 TON
                    </div>
                    <button class="spin-btn">
                        <i class="fas fa-sync-alt"></i>
                        Крутить
                    </button>
                </div>
                <div class="case-card" data-case="shadow">
                    <div class="case-image">
                        <img src="https://nft.fragment.com/gift/iongem-555.medium.jpg" alt="Shadow Cache Case">
                    </div>
                    <div class="case-name">Shadow Cache Case</div>
                    <div class="case-desc">Таинственный теневой кэш.</div>
                    <div class="case-price">
                        <i class="fas fa-coins"></i> <!-- Иконка для TON -->
                        30 TON
                    </div>
                    <button class="spin-btn">
                        <i class="fas fa-sync-alt"></i>
                        Крутить
                    </button>
                </div>
                <div class="case-card" data-case="golden">
                    <div class="case-image">
                        <img src="https://nft.fragment.com/gift/swisswatch-19988.medium.jpg" alt="Golden Satchel Case">
                    </div>
                    <div class="case-name">Golden Satchel Case</div>
                    <div class="case-desc">Золотой саквояж с сюрпризом.</div>
                    <div class="case-price">
                        <i class="fas fa-coins"></i> <!-- Иконка для TON -->
                        100 TON
                    </div>
                    <button class="spin-btn">
                        <i class="fas fa-sync-alt"></i>
                        Крутить
                    </button>
                </div>
                <div class="case-card" data-case="celestial">
                    <div class="case-image">
                        <img src="https://nft.fragment.com/gift/sharptongue-4346.medium.jpg" alt="Celestial Case">
                    </div>
                    <div class="case-name">Celestial Case</div>
                    <div class="case-desc">Небесные сокровища ждут вас.</div>
                    <div class="case-price">
                        <i class="fas fa-coins"></i> <!-- Иконка для TON -->
                        60 TON
                    </div>
                    <button class="spin-btn">
                        <i class="fas fa-sync-alt"></i>
                        Крутить
                    </button>
                </div>
                <div class="case-card" data-case="arcane">
                    <div class="case-image">
                        <img src="https://nft.fragment.com/gift/durovscap-2222.medium.jpg" alt="Arcane Pouch Case">
                    </div>
                    <div class="case-name">Arcane Pouch Case</div>
                    <div class="case-desc">Магический мешок тайн.</div>
                    <div class="case-price">
                        <i class="fas fa-coins"></i> <!-- Иконка для TON -->
                        2490 TON
                    </div>
                    <button class="spin-btn">
                        <i class="fas fa-sync-alt"></i>
                        Крутить
                    </button>
                </div>
                <div class="case-card" data-case="prismatic">
                    <div class="case-image">
                        <img src="https://nft.fragment.com/gift/lootbag-7018.medium.jpg" alt="Prismatic Case">
                    </div>
                    <div class="case-name">Prismatic Case</div>
                    <div class="case-desc">Переливающийся призматический кейс.</div>
                    <div class="case-price">
                        <i class="fas fa-coins"></i> <!-- Иконка для TON -->
                        4999 TON
                    </div>
                    <button class="spin-btn">
                        <i class="fas fa-sync-alt"></i>
                        Крутить
                    </button>
                </div>
                <div class="case-card" data-case="royal">
                    <div class="case-image">
                        <img src="https://nft.fragment.com/gift/heartlocket-269.medium.jpg" alt="Royal Coffer Case">
                    </div>
                    <div class="case-name">Royal Coffer Case</div>
                    <div class="case-desc">Королевский сундук богатства.</div>
                    <div class="case-price">
                        <i class="fas fa-coins"></i> <!-- Иконка для TON -->
                        200 TON
                    </div>
                    <button class="spin-btn">
                        <i class="fas fa-sync-alt"></i>
                        Крутить
                    </button>
                </div>
                <div class="case-card" data-case="fabled">
                    <div class="case-image">
                        <img src="https://nft.fragment.com/gift/diamondring-27070.medium.jpg" alt="Fabled Bag Case">
                    </div>
                    <div class="case-name">Fabled Bag Case</div>
                    <div class="case-desc">Легендарная сумка сказок.</div>
                    <div class="case-price">
                        <i class="fas fa-coins"></i> <!-- Иконка для TON -->
                        999 TON
                    </div>
                    <button class="spin-btn">
                        <i class="fas fa-sync-alt"></i>
                        Крутить
                    </button>
                </div>
                <div class="case-card" data-case="lunar">
                    <div class="case-image">
                        <img src="https://nft.fragment.com/gift/nekohelmet-1244.medium.jpg" alt="Lunar Pack Case">
                    </div>
                    <div class="case-name">Lunar Pack Case</div>
                    <div class="case-desc">Сумка с лунными сокровищами.</div>
                    <div class="case-price">
                        <i class="fas fa-coins"></i> <!-- Иконка для TON -->
                        1999 TON
                    </div>
                    <button class="spin-btn">
                        <i class="fas fa-sync-alt"></i>
                        Крутить
                    </button>
                </div>
            </div>
            <h2 class="section-title">Ваш подарок</h2>
            <div class="result-container" id="result-container">
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-gift"></i>
                    </div>
                    <h3>Еще нет подарка</h3>
                    <p>Выберите кейс и нажмите "Крутить", чтобы получить свой подарок</p>
                </div>
            </div>
            <h2 class="section-title">История открытий</h2>
            <div class="history-container">
                <div id="history-list" class="history-list">
                    <div class="empty-state">
                        <p>Пока нет истории открытий. Откройте кейс, чтобы увидеть свою историю.</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- Upgrade Page -->
        <div id="upgrade-page" class="page-section">
            <!-- Win Message -->
            <div class="win-message-overlay" id="win-message">
                <div class="win-text">WIN</div>
            </div>

            <div class="upgrade-main-container">
                <!-- Header -->
                <div class="upgrade-header">
                    <h2>Улучшение подарков</h2>
                </div>

                <!-- Icon Selection -->
                <div class="upgrade-icons-container">
                    <div class="upgrade-icon-box active" id="my-gifts-icon">
                        <div class="icon-circle">
                            <i class="fas fa-gift"></i>
                        </div>
                        <span>Ваши подарки</span>
                    </div>
                    
                    <div class="upgrade-icon-box" id="desired-gifts-icon">
                        <div class="icon-circle">
                            <i class="fas fa-star"></i>
                        </div>
                        <span>Желаемый подарок</span>
                    </div>
                </div>

                <!-- Selected Gifts Display -->
                <div class="selected-gifts-upgrade">
                    <div class="selected-upgrade-gift">
                        <img id="selected-gift-img" src="" alt="" style="display: none;">
                        <div class="selected-gift-name" id="selected-gift-name"></div>
                        <div class="selected-gift-stars" id="selected-gift-stars"></div>
                        <button class="cancel-gift-btn" id="cancel-selected" style="display: none;">Отменить</button>
                    </div>
                    
                    <div class="selected-upgrade-gift">
                        <img id="desired-gift-img" src="" alt="" style="display: none;">
                        <div class="selected-gift-name" id="desired-gift-name"></div>
                        <div class="selected-gift-stars" id="desired-gift-stars"></div>
                        <button class="cancel-gift-btn" id="cancel-desired" style="display: none;">Отменить</button>
                    </div>
                </div>

                <!-- Upgrade Button -->
                <button class="upgrade-button-final" id="upgrade-final-btn" style="display: none;">
                    АПГРЕЙД
                </button>

                <!-- Wheel Container (Hidden by default) -->
                <div class="upgrade-wheel-container" id="upgrade-wheel-container" style="display: none;">
                    <!-- Содержимое будет создано динамически -->
                </div>

                <!-- All Available Gifts Grid (Hidden by default) -->
                <div class="all-gifts-modal" id="all-gifts-modal" style="display: none;">
                    <div class="all-gifts-modal-header">
                        <h3 id="modal-title">Выберите подарок</h3>
                        <button class="close-modal-btn" id="close-gifts-modal">✕</button>
                    </div>
                    <div class="all-gifts-grid" id="all-gifts-grid-content">
                        <!-- Gifts will be populated here -->
                    </div>
                </div>
            </div>
        </div>
        <!-- Rating Page -->
        <div id="rating-page" class="page-section">
            <h2 class="section-title">Рейтинг пользователей</h2>
            <div class="rating-container">
                <table class="rating-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Пользователь</th>
                            <th>Баланс (TON)</th>
                            <th>Заработано TON</th>
                        </tr>
                    </thead>
                    <tbody id="rating-table-body">
                        <!-- Rating data will be populated here -->
                    </tbody>
                </table>
                <div id="no-rating-data" class="empty-state" style="display: none;">
                    <p>Пока нет данных о рейтинге пользователей.</p>
                </div>
            </div>
        </div>
        <!-- Profile Page -->
        <div id="profile-page" class="page-section">
            <h2 class="section-title">Профиль</h2>
            <div class="profile-container">
                <div class="inventory-container">
                    <div id="inventory-grid-profile" class="inventory-grid">
                        <div class="empty-state">
                            <p>У вас пока нет подарков. Откройте кейс, чтобы получить подарки.</p>
                        </div>
                    </div>
                </div>
                <div class="profile-stats">
                    <div class="stat-card">
                        <div class="stat-label">Депозит</div>
                        <div class="stat-value" id="profile-deposit">0.00 TON</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Кейсов открыто</div>
                        <div class="stat-value" id="profile-cases-opened">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Апгрейдов</div>
                        <div class="stat-value" id="profile-upgrades-performed">0</div>
                    </div>
                </div>
                <div class="promo-section">
                    <h3 class="upgrade-title">Ввести промокод</h3>
                    <input type="text" class="promo-input" id="promo-input" placeholder="Введите промокод">
                    <button class="promo-btn" id="apply-promo-btn">Применить</button>
                </div>
            </div>
        </div>
        <!-- History Page -->
        <div id="history-page" class="page-section">
            <h2 class="section-title">История операций</h2>
            <div class="operations-history">
                <div id="operations-list">
                    <div class="empty-state">
                        <p>Пока нет истории операций.</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- Referral Page -->
        <div id="referral-page" class="page-section">
            <h2 class="section-title">Реф. Программа</h2>
            <div class="rating-container">
                <div class="ref-stats">
                    <div class="ref-stat-card">
                        <div class="ref-stat-label">Всего рефералов</div>
                        <div class="ref-stat-value" id="ref-total">0</div>
                    </div>
                    <div class="ref-stat-card">
                        <div class="ref-stat-label">Всего заработано</div>
                        <div class="ref-stat-value" id="ref-total-earned">0 TON</div>
                    </div>
                    <div class="ref-stat-card">
                        <div class="ref-stat-label">Заработано за месяц</div>
                        <div class="ref-stat-value" id="ref-monthly-earned">0 TON</div>
                    </div>
                </div>
                <div class="ref-code-section">
                    <h3 class="upgrade-title">Создать свой промокод</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">При пополнении через ваш промокод, реферал получит +5% к пополнению.</p>
                    <input type="text" class="promo-input" id="new-promo-input" placeholder="Введите имя для промокода">
                    <button class="promo-btn" id="create-promo-btn">Создать промокод</button>
                    <div class="ref-link-title">Ваша реферальная ссылка:</div>
                    <div class="ref-link" id="ref-link-display">https://t.me/magicdrop_robot/</div>
                </div>
            </div>
        </div>
        
        <!-- Spin Page -->
        <div id="spin-page" class="page-section">
            <div class="spin-page-container">
                <button class="back-btn" id="backFromSpin">
                    <i class="fas fa-arrow-left"></i> Назад к кейсам
                </button>
                <h2 class="section-title">Открываем кейс</h2>
                <div id="spinResult" class="result-container"></div>
            </div>
        </div>
    </div>
    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-page="main">
            <i class="fas fa-home"></i>
            Главная
        </a>
        <a href="#" class="nav-item" data-page="upgrade">
            <i class="fas fa-magic"></i>
            Апгрейд
        </a>
        <a href="#" class="nav-item" data-page="rating">
            <i class="fas fa-trophy"></i>
            Рейтинг
        </a>
        <a href="#" class="nav-item" data-page="profile">
            <i class="fas fa-user"></i>
            Профиль
        </a>
        <a href="#" class="nav-item" data-page="referral">
            <i class="fas fa-users"></i>
            Реф. Программа
        </a>
    </nav>
    <!-- Top Up Modal -->
    <div class="modal" id="topUpModal">
        <div class="modal-content">
            <button class="close-modal" id="closeModal">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="modal-title">Пополнить баланс</h3>
            <div class="payment-options">
                <div class="payment-option" data-method="ton">
                    <div class="payment-icon ton-icon">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="payment-info">
                        <div class="payment-name">TON</div>
                        <div class="payment-desc">Оплатить через Tonkeeper</div>
                    </div>
                </div>
                <div class="payment-option" data-method="telegram">
                    <div class="payment-icon telegram-icon">
                        <i class="fab fa-telegram"></i>
                    </div>
                    <div class="payment-info">
                        <div class="payment-name">Telegram Stars</div>
                        <div class="payment-desc">Оплатить через Telegram Stars</div>
                    </div>
                </div>
            </div>
            <input type="number" class="amount-input" id="amountInput" placeholder="Введите сумму в TON" min="1">
            <button class="confirm-btn" id="confirmTopUp">
                Подтвердить
            </button>
        </div>
    </div>
    <!-- Spin Modal -->
    <div class="modal" id="spinModal">
        <div class="modal-content" style="max-width: 800px;">
            <button class="close-modal" id="closeSpinModal">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="modal-title">Открываем кейс</h3>
            <div id="spinResult" class="result-container" style="margin: 10px 0 0; min-height: 360px;"></div>
        </div>
    </div>
    <!-- Toast notifications -->
    <div class="toast" id="toast"></div>
    <script>
            // Updated items data with correct information from the provided links
            const items = [
                {
                    id: 'witchhat-28131',
                    name: 'Witch Hat (шляпа)',
                    price: 4,
                    image: 'https://nft.fragment.com/gift/witchhat-28131.medium.jpg',
                    rarity: 'common',
                    model: 'Mine Time',
                    backdrop: 'Steel Grey',
                    symbol: 'Moon',
                    issued: '81336 of 88480'
                },
                {
                    id: 'bdaycandle-126281',
                    name: 'B-Day Candle (хепи бездей, свечка)',
                    price: 1.22,
                    image: 'https://nft.fragment.com/gift/bdaycandle-126281.medium.jpg',
                    rarity: 'common',
                    model: 'Tropic Dream',
                    backdrop: 'Azure Blue',
                    symbol: 'Tulip',
                    issued: '258576 of 307521'
                },
                {
                    id: 'berrybox-25500',
                    name: 'Berry Box (клубничка)',
                    price: 5,
                    image: 'https://nft.fragment.com/gift/berrybox-25500.medium.jpg',
                    rarity: 'rare',
                    model: 'High Voltage',
                    backdrop: 'Black',
                    symbol: 'Pearl',
                    issued: '45161 of 66580'
                },
                {
                    id: 'astralshard-3152',
                    name: 'Astral Shard',
                    price: 135,
                    image: 'https://nft.fragment.com/gift/astralshard-3152.medium.jpg',
                    rarity: 'legendary',
                    model: 'Pure Silver',
                    backdrop: 'Black',
                    symbol: 'Lily',
                    issued: '5507 of 6196'
                },
                {
                    id: 'bigyear-34582',
                    name: 'Big Year',
                    price: 2,
                    image: 'https://nft.fragment.com/gift/bigyear-34582.medium.jpg',
                    rarity: 'uncommon',
                    model: 'Tropic Dream',
                    backdrop: 'Azure Blue',
                    symbol: 'Tulip',
                    issued: '258576 of 307521'
                }
            ];
            // DOM elements
            const caseCards = document.querySelectorAll('.case-card');
            const spinBtns = document.querySelectorAll('.spin-btn');
            const resultContainer = document.getElementById('result-container');
            const historyList = document.getElementById('history-list');
            const balanceElement = document.getElementById('balance');
            const topUpBtn = document.getElementById('topUpBtn');
            const topUpModal = document.getElementById('topUpModal');
            const closeModal = document.getElementById('closeModal');
            const confirmTopUp = document.getElementById('confirmTopUp');
            const amountInput = document.getElementById('amountInput');
            const mainPage = document.getElementById('main-page');
            const caseDetails = document.getElementById('case-details');
            const toast = document.getElementById('toast');
            const navItems = document.querySelectorAll('.nav-item');
            const pageSections = document.querySelectorAll('.page-section');
            // Spin modal elements
            const spinModal = document.getElementById('spinModal');
            const spinResult = document.getElementById('spinResult');
            const closeSpinModal = document.getElementById('closeSpinModal');
            // Upgrade elements
            const giftSelect = document.getElementById('gift-select');
            const targetSelect = document.getElementById('target-select');
            const upgradeChance = document.getElementById('upgrade-chance');
            const upgradeCost = document.getElementById('upgrade-cost');
            const upgradeBtn = document.getElementById('upgrade-btn');
            const inventoryGrid = document.getElementById('inventory-grid');
            const selectedGiftPreview = document.getElementById('selected-gift-preview');
            const selectedTargetPreview = document.getElementById('selected-target-preview');
            // Rating elements
            const ratingTableBody = document.getElementById('rating-table-body');
            const noRatingData = document.getElementById('no-rating-data');
            // History elements
            const operationsList = document.getElementById('operations-list');
            let selectedCase = 'start'; // Updated default
            let isRolling = false;
            let rollsHistory = [];
            let currentBalance = 50; // Стартовый баланс в TON
            let spinInterval = null;
            let spinTimeout = null;
            let spinRAFId = null;
            // Inventory and operations
            let userInventory = [];
            let operationsHistory = [];

            // --- Добавленные переменные ---
            let profileStats = {
                deposit: 0, // Сумма пополнений
                casesOpened: 0, // Открытые кейсы
                upgradesPerformed: 0 // Выполненные апгрейды
            };
            let referralStats = {
                totalReferrals: 0,
                totalEarned: 0,
                monthlyEarned: 0
            };
            let userRefCode = null; // Промокод пользователя
            let userRefLink = null; // Реферальная ссылка пользователя


            // Создаем звезды на фоне
            function createStars() {
                const starsContainer = document.getElementById('stars');
                for (let i = 0; i < 200; i++) {
                    const star = document.createElement('div');
                    star.classList.add('star');
                    star.style.width = Math.random() * 4 + 1 + 'px';
                    star.style.height = star.style.width;
                    star.style.top = Math.random() * 100 + '%';
                    star.style.left = Math.random() * 100 + '%';
                    star.style.animationDelay = Math.random() * 8 + 's';
                    star.style.animationDuration = (Math.random() * 4 + 3) + 's';
                    star.style.opacity = Math.random() * 0.8 + 0.2;
                    starsContainer.appendChild(star);
                }
            }

            // Создаем дополнительные частицы для страницы кручения
            function createSpinParticles() {
                const container = document.querySelector('.spin-page-container');
                if (!container) return;

                const particleContainer = document.createElement('div');
                particleContainer.style.position = 'absolute';
                particleContainer.style.top = '0';
                particleContainer.style.left = '0';
                particleContainer.style.width = '100%';
                particleContainer.style.height = '100%';
                particleContainer.style.pointerEvents = 'none';
                particleContainer.style.zIndex = '1';
                container.appendChild(particleContainer);

                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    particle.style.position = 'absolute';
                    particle.style.width = Math.random() * 4 + 2 + 'px';
                    particle.style.height = particle.style.width;
                    particle.style.background = `hsl(${Math.random() * 60 + 200}, 80%, 60%)`;
                    particle.style.borderRadius = '50%';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.opacity = Math.random() * 0.5 + 0.3;
                    particle.style.boxShadow = `0 0 ${Math.random() * 10 + 5}px currentColor`;
                    
                    // Анимация частиц
                    const animation = particle.animate([
                        { 
                            transform: 'translate(0, 0) scale(0)', 
                            opacity: 0 
                        },
                        { 
                            transform: `translate(${Math.random() * 200 - 100}px, ${Math.random() * 200 - 100}px) scale(1)`, 
                            opacity: 1 
                        },
                        { 
                            transform: `translate(${Math.random() * 400 - 200}px, ${Math.random() * 400 - 200}px) scale(0)`, 
                            opacity: 0 
                        }
                    ], {
                        duration: Math.random() * 3000 + 2000,
                        easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)',
                        iterations: Infinity,
                        delay: Math.random() * 2000
                    });

                    particleContainer.appendChild(particle);
                }
            }

            // Создаем эффект взрыва для легендарных предметов
            function createExplosionEffect() {
                const container = document.querySelector('.spin-page-container');
                if (!container) return;

                const explosion = document.createElement('div');
                explosion.style.position = 'absolute';
                explosion.style.top = '50%';
                explosion.style.left = '50%';
                explosion.style.width = '200px';
                explosion.style.height = '200px';
                explosion.style.transform = 'translate(-50%, -50%)';
                explosion.style.pointerEvents = 'none';
                explosion.style.zIndex = '1000';
                explosion.style.borderRadius = '50%';
                explosion.style.background = 'radial-gradient(circle, rgba(255, 215, 0, 0.8) 0%, rgba(255, 165, 0, 0.6) 30%, transparent 70%)';
                explosion.style.animation = 'explosion 1s ease-out forwards';
                container.appendChild(explosion);

                // Добавляем CSS анимацию
                if (!document.getElementById('explosion-style')) {
                    const style = document.createElement('style');
                    style.id = 'explosion-style';
                    style.textContent = `
                        @keyframes explosion {
                            0% { 
                                transform: translate(-50%, -50%) scale(0);
                                opacity: 1;
                            }
                            50% { 
                                transform: translate(-50%, -50%) scale(1.5);
                                opacity: 0.8;
                            }
                            100% { 
                                transform: translate(-50%, -50%) scale(3);
                                opacity: 0;
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }

                setTimeout(() => {
                    explosion.remove();
                }, 1000);
            }

            // Создаем эффект искр для эпических предметов
            function createSparkleEffect() {
                const container = document.querySelector('.spin-page-container');
                if (!container) return;

                for (let i = 0; i < 20; i++) {
                    const sparkle = document.createElement('div');
                    sparkle.style.position = 'absolute';
                    sparkle.style.top = '50%';
                    sparkle.style.left = '50%';
                    sparkle.style.width = '4px';
                    sparkle.style.height = '4px';
                    sparkle.style.background = '#ffd700';
                    sparkle.style.borderRadius = '50%';
                    sparkle.style.pointerEvents = 'none';
                    sparkle.style.zIndex = '1000';
                    sparkle.style.boxShadow = '0 0 10px #ffd700';
                    
                    const angle = (Math.PI * 2 * i) / 20;
                    const distance = 100 + Math.random() * 50;
                    const endX = Math.cos(angle) * distance;
                    const endY = Math.sin(angle) * distance;
                    
                    sparkle.animate([
                        { 
                            transform: 'translate(-50%, -50%) scale(0)',
                            opacity: 1
                        },
                        { 
                            transform: `translate(calc(-50% + ${endX}px), calc(-50% + ${endY}px)) scale(1)`,
                            opacity: 0.8
                        },
                        { 
                            transform: `translate(calc(-50% + ${endX * 1.5}px), calc(-50% + ${endY * 1.5}px)) scale(0)`,
                            opacity: 0
                        }
                    ], {
                        duration: 1000 + Math.random() * 500,
                        easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                    });

                    container.appendChild(sparkle);
                    
                    setTimeout(() => {
                        sparkle.remove();
                    }, 1500);
                }
            }

            // Initialize from localStorage
            function initFromStorage() {
                const savedBalance = localStorage.getItem('bearDropBalance');
                const savedHistory = localStorage.getItem('bearDropHistory');
                const savedInventory = localStorage.getItem('bearDropInventory');
                const savedOperations = localStorage.getItem('bearDropOperations');
                // --- Загрузка новых данных из localStorage ---
                const savedProfileStats = localStorage.getItem('bearDropProfileStats');
                const savedReferralStats = localStorage.getItem('bearDropReferralStats');
                const savedUserRefCode = localStorage.getItem('bearDropUserRefCode');
                const savedUserRefLink = localStorage.getItem('bearDropUserRefLink');

                if (savedBalance) {
                    currentBalance = parseFloat(savedBalance); // Теперь баланс может быть дробным
                    balanceElement.textContent = currentBalance.toFixed(2); // Показываем с 2 знаками
                }
                if (savedHistory) {
                    rollsHistory = JSON.parse(savedHistory);
                    updateHistory();
                }
                if (savedInventory) {
                    userInventory = JSON.parse(savedInventory);
                    updateInventory();
                }
                if (savedOperations) {
                    operationsHistory = JSON.parse(savedOperations);
                    updateOperationsHistory();
                }
                // --- Загрузка новых данных ---
                if (savedProfileStats) {
                    profileStats = JSON.parse(savedProfileStats);
                }
                if (savedReferralStats) {
                    referralStats = JSON.parse(savedReferralStats);
                }
                if (savedUserRefCode) {
                    userRefCode = savedUserRefCode;
                }
                if (savedUserRefLink) {
                    userRefLink = savedUserRefLink;
                }
            }
            function saveToStorage() {
                localStorage.setItem('bearDropBalance', currentBalance.toString());
                localStorage.setItem('bearDropHistory', JSON.stringify(rollsHistory));
                localStorage.setItem('bearDropInventory', JSON.stringify(userInventory));
            }

            function loadFromStorage() {
                const b = localStorage.getItem('bearDropBalance');
                const h = localStorage.getItem('bearDropHistory');
                const i = localStorage.getItem('bearDropInventory');
                if (b) currentBalance = parseFloat(b);
                if (h) rollsHistory = JSON.parse(h);
                if (i) userInventory = JSON.parse(i);
                balanceElement.textContent = currentBalance.toFixed(2);
                updateHistory();
            }

            // Show toast notification
            function showToast(message, isError = false) {
                toast.textContent = message;
                toast.className = 'toast show';
                if (isError) {
                    toast.style.borderLeftColor = '#ff6b6b';
                } else {
                    toast.style.borderLeftColor = '#4e54c8';
                }
                setTimeout(() => {
                    toast.className = 'toast';
                }, 3000);
            }

            // Navigation
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = item.dataset.page;
                    // Update active nav item
                    navItems.forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                    // Show corresponding page
                    pageSections.forEach(section => section.classList.remove('active'));
                    document.getElementById(`${page}-page`).classList.add('active');
                    // Special handling for rating page
                    if (page === 'rating') {
                        loadRatingData();
                    }
                    // Special handling for upgrade page
                    if (page === 'upgrade') {
                        // Initialize spin system when navigating to upgrade page
                        setTimeout(() => {
                            initSpinSystem();
                        }, 100);
                    }
                });
            });

            // Case selection and navigation
            caseCards.forEach(card => {
                card.addEventListener('click', () => {
                    selectedCase = card.dataset.case;
                    // Hide main page and show case details
                    mainPage.style.display = 'none';
                    caseDetails.style.display = 'block';
                    // Create case details content
                    createCaseDetails(selectedCase);
                });
            });

            // Create case details content
            function createCaseDetails(caseType) {
                // Define case data based on type
                const caseDataMap = {
                    start: {
                        name: 'Start Case',
                        price: 1,
                        image: 'https://nft.fragment.com/gift/joyfulbundle-10953.medium.jpg',
                        desc: 'Содержит случайные NFT подарки с разной редкостью и стоимостью'
                    },
                    magic: {
                        name: 'Magic Gift Case',
                        price: 30,
                        image: 'https://nft.fragment.com/gift/berrybox-1337.medium.jpg',
                        desc: 'Содержит редкие и легендарные NFT подарки'
                    },
                    mystic: {
                        name: 'Mystic Vault Case',
                        price: 400,
                        image: 'https://nft.fragment.com/gift/lootbag-7631.medium.jpg',
                        desc: 'Загадочный сундук, полный тайн.'
                    },
                    eternal: {
                        name: 'Eternal Case',
                        price: 30,
                        image: 'https://nft.fragment.com/gift/heartlocket-875.medium.jpg',
                        desc: 'Бесконечные возможности внутри.'
                    },
                    shadow: {
                        name: 'Shadow Cache Case',
                        price: 30,
                        image: 'https://nft.fragment.com/gift/iongem-555.medium.jpg',
                        desc: 'Таинственный теневой кэш.'
                    },
                    golden: {
                        name: 'Golden Satchel Case',
                        price: 100,
                        image: 'https://nft.fragment.com/gift/swisswatch-19988.medium.jpg',
                        desc: 'Золотой саквояж с сюрпризом.'
                    },
                    celestial: {
                        name: 'Celestial Case',
                        price: 60,
                        image: 'https://nft.fragment.com/gift/sharptongue-4346.medium.jpg',
                        desc: 'Небесные сокровища ждут вас.'
                    },
                    arcane: {
                        name: 'Arcane Pouch Case',
                        price: 2490,
                        image: 'https://nft.fragment.com/gift/durovscap-2222.medium.jpg',
                        desc: 'Магический мешок тайн.'
                    },
                    prismatic: {
                        name: 'Prismatic Case',
                        price: 4999,
                        image: 'https://nft.fragment.com/gift/lootbag-7018.medium.jpg',
                        desc: 'Переливающийся призматический кейс.'
                    },
                    royal: {
                        name: 'Royal Coffer Case',
                        price: 200,
                        image: 'https://nft.fragment.com/gift/heartlocket-269.medium.jpg',
                        desc: 'Королевский сундук богатства.'
                    },
                    fabled: {
                        name: 'Fabled Bag Case',
                        price: 999,
                        image: 'https://nft.fragment.com/gift/diamondring-27070.medium.jpg',
                        desc: 'Легендарная сумка сказок.'
                    },
                    lunar: {
                        name: 'Lunar Pack Case',
                        price: 1999,
                        image: 'https://nft.fragment.com/gift/nekohelmet-1244.medium.jpg',
                        desc: 'Сумка с лунными сокровищами.'
                    }
                };
                const caseData = caseDataMap[caseType] || caseDataMap.start; // Fallback to start case
                caseDetails.innerHTML = `
                    <div style="text-align: center; margin-bottom: 40px;">
                        <button class="back-btn" onclick="goBack()">
                            <i class="fas fa-arrow-left"></i> Назад
                        </button>
                        <h2 class="section-title">${caseData.name}</h2>
                        <div style="background: var(--card-bg); border-radius: 20px; padding: 30px; display: inline-block; margin: 20px 0; border: 1px solid var(--glass-border);">
                            <img src="${caseData.image}" alt="${caseData.name}" style="width: 200px; height: 200px; border-radius: 15px; margin-bottom: 20px;">
                            <p style="color: var(--text-secondary); margin-bottom: 20px;">${caseData.desc}</p>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--ton); margin-bottom: 30px;"> <!-- Изменил на TON -->
                                <i class="fas fa-coins"></i> ${caseData.price} TON <!-- Иконка и текст для TON -->
                            </div>
                            <button class="spin-btn" id="caseSpinBtn">
                                <i class="fas fa-sync-alt"></i> Крутить кейс
                            </button>
                        </div>
                    </div>
                `;
                // Add event listener to the spin button in case details
                document.getElementById('caseSpinBtn').addEventListener('click', () => {
                    if (currentBalance < caseData.price) {
                        showToast('Недостаточно средств! Пополните баланс.', true);
                        return;
                    }
                    currentBalance -= caseData.price;
                    balanceElement.textContent = currentBalance.toFixed(2); // Обновляем с 2 знаками
                    saveToStorage();
                    openCase(caseType);
                });
            }

            // Go back to main page
            function goBack() {
                caseDetails.style.display = 'none';
                mainPage.style.display = 'block';
            }

            // Create particles for legendary items
            function createParticles() {
                const container = document.createElement('div');
                container.style.position = 'fixed';
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                container.style.pointerEvents = 'none';
                container.style.zIndex = '1000';
                document.body.appendChild(container);
                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 70%)`;
                    particle.style.left = `${Math.random() * 100}%`;
                    particle.style.top = `${Math.random() * 100}%`;
                    particle.style.width = `${Math.random() * 10 + 5}px`;
                    particle.style.height = particle.style.width;
                    container.appendChild(particle);
                    // Animate particle
                    const animation = particle.animate([
                        { transform: 'translate(0, 0)', opacity: 1 },
                        { transform: `translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px)`, opacity: 0 }
                    ], {
                        duration: Math.random() * 2000 + 1000,
                        easing: 'cubic-bezier(0, 0.9, 0.57, 1)'
                    });
                    animation.onfinish = () => {
                        particle.remove();
                        if (container.children.length === 0) {
                            container.remove();
                        }
                    };
                }
            }

            // Create particles for spin animation
            function createSpinParticles(container) {
                const particleContainer = document.createElement('div');
                particleContainer.style.position = 'absolute';
                particleContainer.style.top = '0';
                particleContainer.style.left = '0';
                particleContainer.style.width = '100%';
                particleContainer.style.height = '100%';
                particleContainer.style.pointerEvents = 'none';
                particleContainer.style.zIndex = '10';
                container.appendChild(particleContainer);
                
                for (let i = 0; i < 30; i++) {
                    const particle = document.createElement('div');
                    particle.style.position = 'absolute';
                    particle.style.width = '6px';
                    particle.style.height = '6px';
                    particle.style.borderRadius = '50%';
                    particle.style.backgroundColor = `hsl(${Math.random() * 60 + 200}, 80%, 60%)`;
                    particle.style.left = '50%';
                    particle.style.top = '50%';
                    particle.style.transform = 'translate(-50%, -50%)';
                    particleContainer.appendChild(particle);
                    
                    // Animate particle
                    const angle = (Math.random() * 360) * (Math.PI / 180);
                    const distance = 150 + Math.random() * 100;
                    const endX = Math.cos(angle) * distance;
                    const endY = Math.sin(angle) * distance;
                    
                    const animation = particle.animate([
                        { 
                            transform: 'translate(-50%, -50%) scale(0)', 
                            opacity: 1 
                        },
                        { 
                            transform: `translate(calc(-50% + ${endX}px), calc(-50% + ${endY}px)) scale(1)`, 
                            opacity: 0.8 
                        },
                        { 
                            transform: `translate(calc(-50% + ${endX * 1.5}px), calc(-50% + ${endY * 1.5}px)) scale(0)`, 
                            opacity: 0 
                        }
                    ], {
                        duration: 1500 + Math.random() * 500,
                        easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                    });
                    
                    animation.onfinish = () => {
                        particle.remove();
                        if (particleContainer.children.length === 0) {
                            particleContainer.remove();
                        }
                    };
                }
            }

            // Функция открытия кейса с точной логикой из кручениее.html
            function openCase(caseType) {
                if (isRolling) return;
                isRolling = true;
                
                // Получаем цену кейса
                const casePrices = {
                    start: 1, magic: 30, mystic: 400, eternal: 30, shadow: 30,
                    golden: 100, celestial: 60, arcane: 2490, prismatic: 4999,
                    royal: 200, fabled: 999, lunar: 1999
                };
                const price = casePrices[caseType] || 1;
                
                if (currentBalance < price) {
                    showToast('Недостаточно средств!', true);
                    isRolling = false;
                    return;
                }
                
                // Списываем стоимость
                currentBalance -= price;
                balanceElement.textContent = currentBalance.toFixed(2);
                saveToStorage();
                
                // Показываем модал
                if (spinModal) {
                    spinModal.classList.add('active');
                }
                
                // Создаем контейнер для колеса
                const wheelContainer = document.createElement('div');
                wheelContainer.className = 'wheel-container';
                wheelContainer.style.cssText = `
                    position: relative;
                    width: 100%;
                    height: 160px;
                    overflow: hidden;
                    border: 2px solid #fff;
                    border-radius: 10px;
                    box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
                `;
                
                // Создаем белую линию
                const stopLine = document.createElement('div');
                stopLine.className = 'stop-line';
                stopLine.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 50%;
                    width: 2px;
                    height: 100%;
                    background: white;
                    transform: translateX(-50%);
                    z-index: 10;
                    box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
                `;
                wheelContainer.appendChild(stopLine);
                
                // Создаем ленту колеса
                const wheelStrip = document.createElement('div');
                wheelStrip.className = 'wheel-strip';
                wheelStrip.id = 'wheel';
                wheelStrip.style.cssText = `
                    display: flex;
                    gap: 20px;
                    white-space: nowrap;
                    transform: translateX(0);
                    transition: transform 0s linear;
                `;
                wheelContainer.appendChild(wheelStrip);
                
                // Очищаем и добавляем контейнер
                spinResult.innerHTML = '';
                spinResult.appendChild(wheelContainer);
                
                // Генерируем базовое колесо
                generateBaseWheel(wheelStrip);
                
                // Запускаем кручение
                startSpinning(wheelStrip, caseType);
            }

            // Генерация начальной ленты (точная копия из кручениее.html)
            function generateBaseWheel(wheelStrip) {
                wheelStrip.innerHTML = '';
                let lastTwoItems = [];
                
                // Начинаем с 100 элементов — достаточно для плавного старта
                for (let i = 0; i < 100; i++) {
                    const newItem = getRandomItemWithConsecutiveLimit(lastTwoItems);
                    wheelStrip.appendChild(createGiftElement(newItem));
                    lastTwoItems.push(newItem);
                    if (lastTwoItems.length > 2) {
                        lastTwoItems.shift();
                    }
                }
            }
            
            function createGiftElement(item) {
                const gift = document.createElement("div");
                gift.className = "gift";
                gift.__itemData = item;
                gift.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" onerror="this.style.display='none'">
                `;
                return gift;
            }

            // Функция для получения цвета редкости
            function getRarityColor(rarity) {
                const colors = {
                    common: 'var(--common)',
                    uncommon: 'var(--uncommon)',
                    rare: 'var(--rare)',
                    epic: 'var(--epic)',
                    legendary: 'var(--legendary)'
                };
                return colors[rarity] || 'var(--common)';
            }

            // Глобальная переменная для хранения текущей позиции
            let currentTransformValue = 0;

            // Функция кручения (точная копия из кручениее.html)
            function startSpinning(wheelStrip, caseType) {
                const winItem = getRandomItem();
                const containerWidth = wheelStrip.parentElement.offsetWidth;
                const giftWidth = 140; // 120px + 20px gap

                const visibleCount = Math.ceil(containerWidth / giftWidth) + 3;
                const extraRolls = 15;
                const totalItemsToPass = extraRolls * visibleCount;

                const currentCount = wheelStrip.children.length;
                const neededCount = currentCount + totalItemsToPass + 1 + 7;

                let lastTwoItems = [];
                if (wheelStrip.children.length >= 2) {
                    lastTwoItems = [
                        wheelStrip.children[wheelStrip.children.length - 2].__itemData,
                        wheelStrip.children[wheelStrip.children.length - 1].__itemData
                    ];
                } else if (wheelStrip.children.length === 1) {
                    lastTwoItems = [wheelStrip.children[0].__itemData];
                }

                // Добавляем случайные элементы до нужной длины с учетом ограничения
                while (wheelStrip.children.length < neededCount - 8) {
                    const newItem = getRandomItemWithConsecutiveLimit(lastTwoItems);
                    const element = createGiftElement(newItem);
                    element.__itemData = newItem;
                    wheelStrip.appendChild(element);
                    lastTwoItems.push(newItem);
                    if (lastTwoItems.length > 2) {
                        lastTwoItems.shift();
                    }
                }

                // Добавляем выигрышный элемент
                const winElement = createGiftElement(winItem);
                winElement.__itemData = winItem;
                wheelStrip.appendChild(winElement);

                lastTwoItems.push(winItem);
                if (lastTwoItems.length > 2) {
                    lastTwoItems.shift();
                }

                // Добавляем 7 случайных элементов после выигрышного
                for (let i = 0; i < 7; i++) {
                    const newItem = getRandomItemWithConsecutiveLimit(lastTwoItems);
                    const element = createGiftElement(newItem);
                    element.__itemData = newItem;
                    wheelStrip.appendChild(element);
                    lastTwoItems.push(newItem);
                    if (lastTwoItems.length > 2) {
                        lastTwoItems.shift();
                    }
                }

                const winIndex = wheelStrip.children.length - 1 - 7;
                const winElementCenterPosition = winIndex * giftWidth + (giftWidth - 20) / 2; // Центр подарка (120px)
                const stopOffset = winElementCenterPosition - (containerWidth / 2);

                wheelStrip.style.transition = 'none';
                wheelStrip.style.transform = `translateX(0px)`;
                void wheelStrip.offsetWidth;

                const duration = 15000;
                wheelStrip.style.transition = `transform ${duration}ms cubic-bezier(0.2, 0.8, 0.3, 1)`;
                wheelStrip.style.transform = `translateX(-${stopOffset}px)`;

                setTimeout(() => {
                    isRolling = false;
                    
                    // Добавляем выигрышный элемент в инвентарь
                    userInventory.push(winItem);
                    rollsHistory.unshift(winItem);
                    if (rollsHistory.length > 10) rollsHistory.pop();

                    // Добавляем в историю операций
                    operationsHistory.unshift({
                        type: 'case_open',
                        item: winItem,
                        case: caseType,
                        date: new Date().toLocaleString('ru-RU')
                    });

                    updateResult(winItem);
                    updateHistory();
                    updateInventory();
                    updateInventoryProfile();
                    saveToStorage();
                    
                    // Специальный эффект для легендарных предметов
                    if (winItem.rarity === 'legendary') {
                        createParticles();
                    }
                    
                    // Закрываем модал
                    if (spinModal) {
                        spinModal.classList.remove('active');
                    }
                }, duration);
            }
            
            function getRandomItem(excludeItems = []) {
                const availableItems = items.filter(item => !excludeItems.includes(item));
                // Простой случайный выбор, так как в miniapp.html нет поля chance
                return availableItems[Math.floor(Math.random() * availableItems.length)];
            }

            function getRandomItemWithConsecutiveLimit(lastTwoItems = []) {
                if (lastTwoItems.length === 2 && lastTwoItems[0].rarity === lastTwoItems[1].rarity) {
                    const sameRarityItems = items.filter(item => item.rarity === lastTwoItems[0].rarity);
                    return getRandomItem(sameRarityItems);
                }
                return getRandomItem();
            }

            // Обновляем классы элементов для выделения активного
            function updateActiveItem(reelStrip) {
                if (!reelStrip) return;

                const items = Array.from(reelStrip.children);
                const stripRect = reelStrip.getBoundingClientRect();
                const indicatorRect = document.querySelector('.indicator')?.getBoundingClientRect();
                if (!indicatorRect) return;

                const indicatorCenter = indicatorRect.left + indicatorRect.width / 2;

                // Сброс всех классов
                items.forEach(item => {
                    item.classList.remove('active', 'left', 'right');
                });

                // Находим элемент под индикатором
                let activeIndex = -1;
                for (let i = 0; i < items.length; i++) {
                    const itemRect = items[i].getBoundingClientRect();
                    const itemCenter = itemRect.left + itemRect.width / 2;
                    if (Math.abs(indicatorCenter - itemCenter) < 10) {
                        activeIndex = i;
                        break;
                    }
                }

                if (activeIndex !== -1) {
                    items[activeIndex].classList.add('active');
                    if (activeIndex > 0) items[activeIndex - 1].classList.add('left');
                    if (activeIndex < items.length - 1) items[activeIndex + 1].classList.add('right');
                }
            }

            function updateResult(item) {
                const rarityClass = `rarity ${item.rarity}`;
                resultContainer.innerHTML = `
                    <div class="item-display">
                        <img src="${item.image}" alt="${item.name}" class="item-image" onerror="this.src='https://via.placeholder.com/300?text=🎁'">
                        <div class="item-info">
                            <div class="${rarityClass}">${item.rarity}</div>
                            <h3 class="item-name">${item.name}</h3>
                            <div class="item-price"><i class="fas fa-coins"></i> ${item.price} TON</div>
                            <button class="claim-btn"><i class="fas fa-gift"></i> Забрать подарок</button>
                        </div>
                    </div>
                `;
                resultContainer.querySelector('.claim-btn').addEventListener('click', () => {
                    showToast(`Вы получили ${item.name}!`);
                });
            }

            // Функция для показа страницы кручения
            function showSpinPage() {
                // Показываем модал кручения
                if (spinModal) {
                    spinModal.classList.add('active');
                }
                // Создаем частицы для страницы кручения
                setTimeout(() => {
                    createSpinParticles();
                }, 100);
            }

            // Функция для возврата с страницы кручения
            function backFromSpinPage() {
                // Скрываем модал кручения
                if (spinModal) {
                    spinModal.classList.remove('active');
                }
                // Сбрасываем состояние кручения
                isRolling = false;
            }

            // Function to finish spinning and select final item
            function finishSpin(wheelIndex, finalItem) {
                // Convert special item to regular item format
                const convertedItem = {
                    name: finalItem.type === 'papers' ? 'Stack of Papers' : 
                          finalItem.type === 'bag' ? 'Magic Bag' :
                          finalItem.type === 'chili' ? 'Spicy Chili' :
                          finalItem.type === 'dog' ? 'Cute Dog' :
                          finalItem.type === 'hand' ? 'Golden Hand' : 'Unknown Item',
                    price: finalItem.price,
                    rarity: finalItem.price > 50 ? 'legendary' : 
                           finalItem.price > 20 ? 'epic' :
                           finalItem.price > 10 ? 'rare' :
                           finalItem.price > 5 ? 'uncommon' : 'common',
                    image: 'https://via.placeholder.com/200x200/4e54c8/ffffff?text=' + encodeURIComponent(finalItem.type),
                    model: 'Special',
                    backdrop: 'Gradient',
                    symbol: '⭐',
                    issued: '2024'
                };
                
                // Add to inventory and history
                userInventory.push(convertedItem);
                rollsHistory.unshift(convertedItem);
                // Add to operations history
                operationsHistory.unshift({
                    type: 'case_open',
                    item: convertedItem,
                    case: selectedCase, // Use the global variable selectedCase
                    date: new Date().toLocaleString('ru-RU')
                });
                if (rollsHistory.length > 10) {
                    rollsHistory.pop();
                }
                saveToStorage();

                // --- Увеличиваем статистику профиля ---
                profileStats.casesOpened += 1;
                saveToStorage(); // Сохраняем статистику
                updateProfileStats();

                // Update UI with final item
                updateResultContainer('item', convertedItem);
                updateSpinModal('item', convertedItem);
                updateHistory();
                updateInventory();
                // Special effect for legendary items
                if (convertedItem.rarity === 'legendary') {
                    createParticles();
                    document.body.style.animation = 'none';
                    setTimeout(() => {
                        document.body.style.animation = 'pulse 0.5s';
                    }, 10);
                }
                isRolling = false;
            }

            // Update spin modal content
            function updateSpinModal(state, item = null) {
                if (!spinResult) return;
                if (state === 'rolling') {
                    // Let openCase() populate the spinner UI
                    spinResult.innerHTML = '';
                    return;
                }
                if (state === 'item' && item) {
                    const rarityClass = `rarity ${item.rarity}`;
                    spinResult.innerHTML = `
                        <div class="item-display">
                            <img src="${item.image}" alt="${item.name}" class="item-image">
                            <div class="item-info">
                                <div class="${rarityClass}">${capitalizeFirstLetter(item.rarity)}</div>
                                <h3 class="item-name">${item.name}</h3>
                                <div class="item-meta">
                                    <div class="item-property">
                                        <span>Модель</span>
                                        ${item.model}
                                    </div>
                                    <div class="item-property">
                                        <span>Фон</span>
                                        ${item.backdrop}
                                    </div>
                                    <div class="item-property">
                                        <span>Символ</span>
                                        ${item.symbol}
                                    </div>
                                    <div class="item-property">
                                        <span>Выпущено</span>
                                        ${item.issued}
                                    </div>
                                </div>
                                <div class="item-price">
                                    <i class="fas fa-coins"></i> <!-- Иконка для TON -->
                                    ${item.price} TON
                                </div>
                                <button class="claim-btn">
                                    <i class="fas fa-gift"></i>
                                    Забрать подарок
                                </button>
                            </div>
                        </div>
                    `;
                    const claimBtn = spinResult.querySelector('.claim-btn');
                    if (claimBtn) {
                        claimBtn.addEventListener('click', () => {
                            showToast(`Поздравляем! Вы получили ${item.name} за ${item.price} TON!`);
                            if (spinModal) spinModal.classList.remove('active');
                        });
                    }
                    return;
                }
                // Fallback state
                spinResult.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-gift"></i>
                        </div>
                        <h3>Еще нет подарка</h3>
                        <p>Выберите кейс и нажмите "Крутить", чтобы получить подарок</p>
                    </div>
                `;
            }

            // Update result container
            function updateResultContainer(state, item = null) {
                resultContainer.innerHTML = '';
                if (state === 'rolling') {
                    // This state now serves as a placeholder, the actual spinner is created in openCase
                    // We can keep a simple message or just let the spinner in openCase take over
                    // For clarity, let's just add the spinner container here and let openCase fill it
                    // resultContainer.innerHTML = `<div class="rolling"><h3>Открываем ваш кейс...</h3><p>Подождите немного</p></div>`;
                } else if (state === 'item' && item) {
                    const rarityClass = `rarity ${item.rarity}`;
                    resultContainer.innerHTML = `
                        <div class="item-display">
                            <img src="${item.image}" alt="${item.name}" class="item-image">
                            <div class="item-info">
                                <div class="${rarityClass}">${capitalizeFirstLetter(item.rarity)}</div>
                                <h3 class="item-name">${item.name}</h3>
                                <div class="item-meta">
                                    <div class="item-property">
                                        <span>Модель</span>
                                        ${item.model}
                                    </div>
                                    <div class="item-property">
                                        <span>Фон</span>
                                        ${item.backdrop}
                                    </div>
                                    <div class="item-property">
                                        <span>Символ</span>
                                        ${item.symbol}
                                    </div>
                                    <div class="item-property">
                                        <span>Выпущено</span>
                                        ${item.issued}
                                    </div>
                                </div>
                                <div class="item-price">
                                    <i class="fas fa-coins"></i> <!-- Иконка для TON -->
                                    ${item.price} TON
                                </div>
                                <button class="claim-btn">
                                    <i class="fas fa-gift"></i>
                                    Забрать подарок
                                </button>
                            </div>
                        </div>
                    `;
                    document.querySelector('.claim-btn').addEventListener('click', () => {
                        showToast(`Поздравляем! Вы получили ${item.name} за ${item.price} TON!`);
                        // In a real app, this would trigger an API call to deliver the item
                    });
                } else {
                    resultContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-gift"></i>
                            </div>
                            <h3>Еще нет подарка</h3>
                            <p>Выберите кейс и нажмите "Крутить", чтобы получить подарок</p>
                        </div>
                    `;
                }
            }

            function updateHistory() {
                if (rollsHistory.length === 0) {
                    historyList.innerHTML = '<div class="empty-state"><p>Пока нет истории открытий.</p></div>';
                    return;
                }
                historyList.innerHTML = '';
                rollsHistory.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'history-item';
                    el.innerHTML = `
                        <img src="${item.image}" alt="${item.name}" class="history-image">
                        <div class="history-name">${item.name}</div>
                        <div class="history-meta">
                            <span class="rarity ${item.rarity}">${item.rarity}</span>
                            <span>${item.price} TON</span>
                        </div>
                    `;
                    historyList.appendChild(el);
                });
            }

            // Update inventory
            function updateInventory() {
                if (userInventory.length === 0) {
                    inventoryGrid.innerHTML = `
                        <div class="empty-state">
                            <p>У вас пока нет подарков. Откройте кейс, чтобы получить подарки.</p>
                        </div>
                    `;
                    // Clear selects
                    giftSelect.innerHTML = '<option value="">Выберите подарок для улучшения</option>';
                    targetSelect.innerHTML = '<option value="">Выберите желаемый подарок</option>';
                    selectedGiftPreview.style.display = 'none';
                    selectedTargetPreview.style.display = 'none';
                    upgradeBtn.disabled = true;
                    return;
                }
                inventoryGrid.innerHTML = '';
                giftSelect.innerHTML = '<option value="">Выберите подарок для улучшения</option>';
                targetSelect.innerHTML = '<option value="">Выберите желаемый подарок</option>';
                
                // Add user's inventory items to gift select (only items they own)
                userInventory.forEach((item, index) => {
                    const rarityClass = `rarity ${item.rarity}`;
                    // Add to inventory grid
                    const inventoryItem = document.createElement('div');
                    inventoryItem.className = 'inventory-item';
                    inventoryItem.dataset.index = index;
                    inventoryItem.innerHTML = `
                        <img src="${item.image}" alt="${item.name}" class="inventory-image">
                        <div class="inventory-name">${item.name}</div>
                        <div class="${rarityClass} inventory-rarity">${capitalizeFirstLetter(item.rarity)}</div>
                    `;
                    inventoryGrid.appendChild(inventoryItem);
                    // Add to gift select (only owned items)
                    const giftOption = document.createElement('option');
                    giftOption.value = index;
                    giftOption.textContent = `${item.name} (${capitalizeFirstLetter(item.rarity)})`;
                    giftSelect.appendChild(giftOption);
                });
                
                // Add ALL available items to target select (any item can be desired)
                items.forEach((item, index) => {
                    const targetOption = document.createElement('option');
                    targetOption.value = `all_${index}`; // Prefix to distinguish from inventory items
                    targetOption.textContent = `${item.name} (${capitalizeFirstLetter(item.rarity)}) - ${item.price} TON`;
                    targetSelect.appendChild(targetOption);
                });
                
                // Add event listeners to inventory items
                document.querySelectorAll('.inventory-item').forEach(item => {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.inventory-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                    });
                });
            }

            // --- New Spin System ---
            
            // Spin system state
            let selectedGift = null;
            let desiredGift = null;
            let currentTab = 'my-gifts';
            let isSpinning = false;

            // Available gifts for upgrade
            const availableGifts = [
                { id: 1, emoji: '🧸', price: 1, name: 'Teddy Bear' },
                { id: 2, emoji: '🎁', price: 2, name: 'Gift Box' },
                { id: 3, emoji: '🎂', price: 3, name: 'Birthday Cake' },
                { id: 4, emoji: '🌹', price: 4, name: 'Rose' },
                { id: 5, emoji: '💐', price: 5, name: 'Bouquet' },
                { id: 6, emoji: '🚀', price: 6, name: 'Rocket' },
                { id: 7, emoji: '🍾', price: 7, name: 'Champagne' },
                { id: 8, emoji: '💖', price: 8, name: 'Heart' },
                { id: 9, emoji: '🎈', price: 9, name: 'Balloon' },
                { id: 10, emoji: '🎪', price: 10, name: 'Circus' },
                { id: 11, emoji: '🎭', price: 11, name: 'Theater' },
                { id: 12, emoji: '🎨', price: 12, name: 'Art' },
                { id: 13, emoji: '🎵', price: 13, name: 'Music' },
                { id: 14, emoji: '🎸', price: 14, name: 'Guitar' },
                { id: 15, emoji: '🎺', price: 15, name: 'Trumpet' },
                { id: 16, emoji: '🎻', price: 16, name: 'Violin' }
            ];

            // Initialize spin system
            function initSpinSystem() {
                console.log('Initializing new spin system...');
                
                // Set up tab switching
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', () => {
                        const tab = button.dataset.tab;
                        switchTab(tab);
                    });
                });
                
                // Set up spin button
                document.getElementById('spin-button').addEventListener('click', startSpin);
                
                // Set up test gifts button
                document.getElementById('add-test-gifts').addEventListener('click', addTestGifts);
                
                // Update displays
                updateBalance();
                updateGiftsGrid();
                updateSpinInfo();
                
                console.log('Spin system initialized');
            }

            // Switch between tabs
            function switchTab(tab) {
                currentTab = tab;
                
                // Update tab buttons
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
                
                // Update gifts grid
                updateGiftsGrid();
            }

            // Update gifts grid based on current tab
            function updateGiftsGrid() {
                const grid = document.getElementById('gifts-grid');
                if (!grid) return;
                
                grid.innerHTML = '';
                
                if (currentTab === 'my-gifts') {
                    // Show user's inventory
                    if (userInventory.length === 0) {
                        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #9ca3af; padding: 20px;">У вас нет подарков</div>';
                        return;
                    }
                    
                    userInventory.forEach((item, index) => {
                        const gift = {
                            id: item.id || index,
                            emoji: item.emoji || '🎁',
                            price: item.price || 1,
                            name: item.name || 'Gift'
                        };
                        
                        const giftElement = createGiftElement(gift, 'my-gifts');
                        grid.appendChild(giftElement);
                    });
                } else {
                    // Show all available gifts
                    availableGifts.forEach(gift => {
                        const giftElement = createGiftElement(gift, 'all-gifts');
                        grid.appendChild(giftElement);
                    });
                }
            }

            // Create gift element
            function createGiftElement(gift, type) {
                const element = document.createElement('div');
                element.className = 'gift-item';
                element.innerHTML = `
                    <div class="gift-emoji">${gift.emoji}</div>
                    <div class="gift-name">${gift.name}</div>
                    <div class="gift-price">${gift.price} TON</div>
                `;
                
                element.addEventListener('click', () => {
                    selectGift(gift, type);
                });
                
                return element;
            }

            // Select gift
            function selectGift(gift, type) {
                if (type === 'my-gifts') {
                    selectedGift = gift;
                    updateSelectedGiftDisplay();
                } else {
                    desiredGift = gift;
                    updateDesiredGiftDisplay();
                }
                
                updateSpinInfo();
                updateSpinButton();
            }

            // Update selected gift display
            function updateSelectedGiftDisplay() {
                const display = document.getElementById('selected-gift-display');
                if (selectedGift) {
                    display.innerHTML = `
                        <div class="selected-gift">
                            <div class="gift-emoji">${selectedGift.emoji}</div>
                            <div class="gift-name">${selectedGift.name}</div>
                            <div class="gift-price">${selectedGift.price} TON</div>
                        </div>
                    `;
                    display.classList.add('has-gift');
                } else {
                    display.innerHTML = '<div class="empty-gift">Выберите подарок</div>';
                    display.classList.remove('has-gift');
                }
            }

            // Update desired gift display
            function updateDesiredGiftDisplay() {
                const display = document.getElementById('desired-gift-display');
                if (desiredGift) {
                    display.innerHTML = `
                        <div class="selected-gift">
                            <div class="gift-emoji">${desiredGift.emoji}</div>
                            <div class="gift-name">${desiredGift.name}</div>
                            <div class="gift-price">${desiredGift.price} TON</div>
                        </div>
                    `;
                    display.classList.add('has-gift');
                } else {
                    display.innerHTML = '<div class="empty-gift">Выберите подарок</div>';
                    display.classList.remove('has-gift');
                }
            }

            // Update spin info (chance and cost)
            function updateSpinInfo() {
                if (!selectedGift || !desiredGift) {
                    document.getElementById('chance-percent').textContent = '0';
                    document.getElementById('upgrade-cost').textContent = '0';
                    hideSuccessZone();
                    return;
                }
                
                // Calculate chance based on price difference
                const priceDiff = desiredGift.price - selectedGift.price;
                let chance = 50;
                
                if (priceDiff > 0) {
                    chance -= Math.min(priceDiff * 2, 40);
                } else if (priceDiff < 0) {
                    chance += Math.min(Math.abs(priceDiff) * 1.5, 30);
                }
                
                chance = Math.max(5, Math.min(95, chance));
                
                // Calculate cost
                const cost = Math.ceil(desiredGift.price * 0.25);
                
                document.getElementById('chance-percent').textContent = chance;
                document.getElementById('upgrade-cost').textContent = cost;
                
                // Show success zone with calculated size
                showSuccessZone(chance);
            }

            // Show success zone with calculated size
            function showSuccessZone(chance) {
                const successZone = document.getElementById('success-zone');
                if (!successZone) return;
                
                // Calculate zone width based on chance (5% to 95% = 20px to 120px)
                const minWidth = 20;
                const maxWidth = 120;
                const zoneWidth = minWidth + (chance / 100) * (maxWidth - minWidth);
                
                successZone.style.width = `${zoneWidth}px`;
                successZone.classList.add('visible');
            }

            // Hide success zone
            function hideSuccessZone() {
                const successZone = document.getElementById('success-zone');
                if (successZone) {
                    successZone.classList.remove('visible');
                }
            }


            // Update spin button state
            function updateSpinButton() {
                const button = document.getElementById('spin-button');
                if (selectedGift && desiredGift && !isSpinning) {
                    button.disabled = false;
                    button.textContent = 'Крутить колесо';
                } else if (isSpinning) {
                    button.disabled = true;
                    button.textContent = 'Вращается...';
                } else {
                    button.disabled = true;
                    button.textContent = 'Крутить колесо';
                }
            }

            // Update balance display
            function updateBalance() {
                document.getElementById('spin-balance').textContent = currentBalance.toFixed(2);
            }

            // Start spin animation
            function startSpin() {
                if (!selectedGift || !desiredGift || isSpinning) return;
                
                isSpinning = true;
                updateSpinButton();
                
                // Calculate success chance
                const priceDiff = desiredGift.price - selectedGift.price;
                let chance = 50;
                
                if (priceDiff > 0) {
                    chance -= Math.min(priceDiff * 2, 40);
                } else if (priceDiff < 0) {
                    chance += Math.min(Math.abs(priceDiff) * 1.5, 30);
                }
                chance = Math.max(5, Math.min(95, chance));
                
                // Calculate cost
                const cost = Math.ceil(desiredGift.price * 0.25);
                
                // Check if user has enough balance
                if (currentBalance < cost) {
                    showToast('Недостаточно средств!', true);
                    isSpinning = false;
                    updateSpinButton();
                    return;
                }
                
                // Deduct cost
                currentBalance -= cost;
                updateBalance();
                saveToStorage();
                
                // Create and populate reel
                createSpinReel();
                
                // Start horizontal spin animation
                startHorizontalSpin(chance);
            }

            // Create spin reel with gift cards
            function createSpinReel() {
                const reel = document.getElementById('spin-reel');
                reel.innerHTML = '';
                
                // Create multiple copies of gifts for smooth scrolling
                const allGifts = [...availableGifts, ...availableGifts, ...availableGifts];
                
                allGifts.forEach((gift, index) => {
                    const card = document.createElement('div');
                    card.className = 'gift-card';
                    
                    // Assign random color theme
                    const themes = ['golden', 'blue', 'purple', 'green', 'red'];
                    const theme = themes[Math.floor(Math.random() * themes.length)];
                    card.classList.add(theme);
                    
                    card.innerHTML = `
                        <div class="gift-image">${gift.emoji}</div>
                        <div class="gift-value">${gift.price.toFixed(2)}</div>
                        <div class="gift-currency">TON</div>
                    `;
                    
                    reel.appendChild(card);
                });
            }

            // Start horizontal spin animation
            function startHorizontalSpin(chance) {
                const reel = document.getElementById('spin-reel');
                const skipButton = document.getElementById('skip-button');
                
                // Show skip button
                skipButton.style.display = 'block';
                
                // Calculate animation parameters
                const cardWidth = 160; // 150px + 10px margin
                const totalCards = reel.children.length;
                const totalWidth = totalCards * cardWidth;
                
                // Calculate target position (center of screen)
                const containerWidth = reel.parentElement.offsetWidth;
                const centerPosition = containerWidth / 2 - cardWidth / 2;
                
                // Calculate success zone boundaries
                const successZone = document.getElementById('success-zone');
                const zoneWidth = parseFloat(successZone.style.width) || 80;
                const zoneLeft = centerPosition - zoneWidth / 2;
                const zoneRight = centerPosition + zoneWidth / 2;
                
                // Determine if we should land in success zone or miss it
                const shouldSucceed = Math.random() * 100 < chance;
                let finalPosition;
                
                if (shouldSucceed) {
                    // Land somewhere in the success zone
                    finalPosition = zoneLeft + Math.random() * zoneWidth;
                } else {
                    // Land outside the success zone
                    const missDistance = cardWidth * 2; // Distance to miss by
                    if (Math.random() < 0.5) {
                        // Miss to the left
                        finalPosition = zoneLeft - missDistance - Math.random() * cardWidth;
                    } else {
                        // Miss to the right
                        finalPosition = zoneRight + missDistance + Math.random() * cardWidth;
                    }
                }
                
                // Animation parameters
                const duration = 4000; // 4 seconds
                const startTime = Date.now();
                let animationId;
                
                // Easing function for smooth deceleration
                function easeOutCubic(t) {
                    return 1 - Math.pow(1 - t, 3);
                }
                
                function animate() {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Apply easing
                    const easedProgress = easeOutCubic(progress);
                    
                    // Calculate position (start from right, move to left)
                    const startPosition = totalWidth;
                    const currentPosition = startPosition - (startPosition - finalPosition) * easedProgress;
                    
                    // Apply transform
                    reel.style.transform = `translateX(-${currentPosition}px)`;
                    
                    if (progress < 1) {
                        animationId = requestAnimationFrame(animate);
                    } else {
                        // Animation finished
                        setTimeout(() => {
                            handleSpinResult(shouldSucceed);
                        }, 500);
                    }
                }
                
                // Start animation
                animate();
                
                // Skip button functionality
                skipButton.onclick = () => {
                    cancelAnimationFrame(animationId);
                    handleSpinResult(shouldSucceed);
                };
            }

            // Handle spin result
            function handleSpinResult(isSuccess) {
                isSpinning = false;
                updateSpinButton();
                
                // Hide skip button and success zone
                const skipButton = document.getElementById('skip-button');
                skipButton.style.display = 'none';
                hideSuccessZone();
                
                if (isSuccess) {
                    // Success - replace selected gift with desired gift
                    const giftIndex = userInventory.findIndex(item => 
                        item.name === selectedGift.name && item.price === selectedGift.price
                    );
                    
                    if (giftIndex !== -1) {
                        // Convert desired gift to inventory format
                        const newItem = {
                            id: desiredGift.id,
                            name: desiredGift.name,
                            price: desiredGift.price,
                            image: `https://via.placeholder.com/200x200/4e54c8/ffffff?text=${encodeURIComponent(desiredGift.emoji)}`,
                            rarity: desiredGift.price > 12 ? 'legendary' : 
                                   desiredGift.price > 8 ? 'epic' :
                                   desiredGift.price > 4 ? 'rare' : 'common',
                            model: 'Upgraded',
                            backdrop: 'Gradient',
                            symbol: '⭐',
                            issued: '2024',
                            emoji: desiredGift.emoji
                        };
                        
                        userInventory[giftIndex] = newItem;
                        
                        // Add to operations history
                        operationsHistory.unshift({
                            type: 'upgrade_success',
                            from: selectedGift,
                            to: desiredGift,
                            date: new Date().toLocaleString('ru-RU')
                        });
                        
                        saveToStorage();
                        updateInventory();
                        updateInventoryProfile();
                        updateOperationsHistory();
                        
                        // Update profile stats
                        profileStats.upgradesPerformed += 1;
                        saveToStorage();
                        updateProfileStats();
                        
                        showToast(`🎉 Успех! Получен ${desiredGift.name}!`, false);
                    }
                } else {
                    // Failure - remove selected gift
                    const giftIndex = userInventory.findIndex(item => 
                        item.name === selectedGift.name && item.price === selectedGift.price
                    );
                    
                    if (giftIndex !== -1) {
                        const lostItem = userInventory[giftIndex];
                        userInventory.splice(giftIndex, 1);
                        
                        // Add to operations history
                        operationsHistory.unshift({
                            type: 'upgrade_failed',
                            from: lostItem,
                            date: new Date().toLocaleString('ru-RU')
                        });
                        
                        saveToStorage();
                        updateInventory();
                        updateInventoryProfile();
                        updateOperationsHistory();
                        
                        // Update profile stats
                        profileStats.upgradesPerformed += 1;
                        saveToStorage();
                        updateProfileStats();
                        
                        showToast('❌ Неудача! Подарок утерян.', true);
                    }
                }
                
                // Reset selections
                selectedGift = null;
                desiredGift = null;
                updateSelectedGiftDisplay();
                updateDesiredGiftDisplay();
                updateSpinInfo();
                updateGiftsGrid();
            }

            // Add test gifts to inventory
            function addTestGifts() {
                const testGifts = [
                    {
                        id: 'test1',
                        name: 'Teddy Bear',
                        price: 1,
                        image: 'https://via.placeholder.com/200x200/4e54c8/ffffff?text=🧸',
                        rarity: 'common',
                        model: 'Test',
                        backdrop: 'Gradient',
                        symbol: '⭐',
                        issued: '2024',
                        emoji: '🧸'
                    },
                    {
                        id: 'test2',
                        name: 'Gift Box',
                        price: 2,
                        image: 'https://via.placeholder.com/200x200/4e54c8/ffffff?text=🎁',
                        rarity: 'common',
                        model: 'Test',
                        backdrop: 'Gradient',
                        symbol: '⭐',
                        issued: '2024',
                        emoji: '🎁'
                    },
                    {
                        id: 'test3',
                        name: 'Birthday Cake',
                        price: 3,
                        image: 'https://via.placeholder.com/200x200/4e54c8/ffffff?text=🎂',
                        rarity: 'uncommon',
                        model: 'Test',
                        backdrop: 'Gradient',
                        symbol: '⭐',
                        issued: '2024',
                        emoji: '🎂'
                    }
                ];
                
                userInventory.push(...testGifts);
                saveToStorage();
                updateInventory();
                updateInventoryProfile();
                updateGiftsGrid();
                
                showToast('Тестовые подарки добавлены!', false);
            }

            function handleSpinResult() {
                const targetZone = document.getElementById('upgrade-target-zone');
                const centerContent = document.getElementById('upgrade-center-content');
                
                if (spinResult === 'win') {
                    targetZone.classList.add('win');
                    centerContent.textContent = '🎉 ПОБЕДА!';
                    handleUpgradeSuccess();
                } else {
                    targetZone.classList.add('lose');
                    centerContent.textContent = '❌ ПОРАЖЕНИЕ';
                    handleUpgradeFailure();
                }
                
                updateSpinButton();
            }

            function handleUpgradeSuccess() {
                // Replace selected gift with desired gift
                if (selectedGift && desiredGift) {
                    // Find and replace in userInventory
                    const giftIndex = userInventory.findIndex(item => 
                        item.name === selectedGift.name && item.price === selectedGift.stars
                    );
                    
                    if (giftIndex !== -1) {
                        // Convert desired gift to inventory format
                        const newItem = {
                            id: desiredGift.id,
                            name: desiredGift.name,
                            price: desiredGift.stars, // Use stars as price
                            image: `https://via.placeholder.com/200x200/4e54c8/ffffff?text=${encodeURIComponent(desiredGift.emoji)}`,
                            rarity: desiredGift.stars > 12 ? 'legendary' : 
                                   desiredGift.stars > 8 ? 'epic' :
                                   desiredGift.stars > 4 ? 'rare' : 'common',
                            model: 'Upgraded',
                            backdrop: 'Gradient',
                            symbol: '⭐',
                            issued: '2024',
                            emoji: desiredGift.emoji
                        };
                        
                        userInventory[giftIndex] = newItem;

                // Add to operations history
                operationsHistory.unshift({
                    type: 'upgrade_success',
                            from: selectedGift,
                            to: desiredGift,
                    date: new Date().toLocaleString('ru-RU')
                });

                saveToStorage();
                updateInventory();
                updateInventoryProfile();
                updateOperationsHistory();

                // Update profile stats
                profileStats.upgradesPerformed += 1;
                saveToStorage();
                updateProfileStats();
                        
                        showToast(`Поздравляем! Вы получили ${desiredGift.name}!`, false);
                    }
                }
                
                // Show success screen
                showSuccessScreen = true;
                showUpgradeSuccessScreen();
            }

            function handleUpgradeFailure() {
                if (selectedGift) {
                    // Remove the selected gift from inventory
                    const giftIndex = userInventory.findIndex(item => 
                        item.name === selectedGift.name && item.price === selectedGift.stars
                    );
                    
                    if (giftIndex !== -1) {
                const lostItem = userInventory[giftIndex];
                userInventory.splice(giftIndex, 1);

                // Add to operations history
                operationsHistory.unshift({
                    type: 'upgrade_failed',
                    from: lostItem,
                    date: new Date().toLocaleString('ru-RU')
                });

                saveToStorage();
                updateInventory();
                updateInventoryProfile();
                updateOperationsHistory();

                // Update profile stats
                profileStats.upgradesPerformed += 1;
                saveToStorage();
                updateProfileStats();
                        
                        showToast('Улучшение не удалось. Подарок утерян.', true);
                    }
                }
            }

            function showUpgradeSuccessScreen() {
                if (!showSuccessScreen || !desiredGift) return;
                
                const upgradePage = document.getElementById('upgrade-page');
                upgradePage.innerHTML = `
                    <div class="upgrade-success-screen">
                        <div class="upgrade-success-content">
                            <div class="upgrade-success-emoji">${desiredGift.emoji}</div>
                            <h1 class="upgrade-success-title">Успешное улучшение!</h1>
                            <p class="upgrade-success-desc">Поздравляем Вас! Ваш подарок был улучшен, что планируете с ним сделать?</p>
                            <button class="upgrade-success-continue" onclick="handleContinue()">
                                Продолжить
                            </button>
                            <div class="upgrade-success-actions">
                                <button class="upgrade-success-action">
                                    Продать за 0.16 ▼
                                </button>
                                <button class="upgrade-success-action">
                                    ✨ Улучшить
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            function handleContinue() {
                showSuccessScreen = false;
                selectedGift = null;
                desiredGift = null;
                upgradeSuccess = false;
                spinResult = null;
                
                // Reset the upgrade page
                location.reload(); // Simple way to reset the page
            }

            function renderGiftCard(gift, isSelected = false, isDesired = false) {
                return `
                    <div class="upgrade-gift-item ${isSelected || isDesired ? 'selected' : ''}">
                        <div class="gift-emoji">${gift.emoji}</div>
                        <div class="gift-stars">${gift.stars} ★</div>
                        ${isSelected ? 
                            `<button class="gift-button" onclick="handleCancelGift('selected')">Отменить</button>` :
                            isDesired ? 
                            `<button class="gift-button" onclick="handleCancelGift('desired')">Отменить</button>` :
                            `<button class="gift-button select" data-gift-id="${gift.id}">Выбрать</button>`
                        }
                    </div>
                `;
            }

            function updateUpgradeGiftGrid() {
                console.log('updateUpgradeGiftGrid called, activeTab:', activeTab);
                const grid = document.getElementById('upgrade-gift-grid');
                if (!grid) {
                    console.error('upgrade-gift-grid element not found!');
                    return;
                }
                
                grid.innerHTML = '';
                console.log('Grid cleared');
                
                if (activeTab === 'yourGifts') {
                    console.log('Showing your gifts, inventory length:', userInventory.length);
                    // Show only gifts from user's inventory
                    if (userInventory.length === 0) {
                        grid.innerHTML = '<div class="empty-state"><p>У вас пока нет подарков. Откройте кейс или добавьте тестовые подарки для улучшения.</p></div>';
                        console.log('Showing empty state for your gifts');
                        return;
                    }
                    
                    userInventory.forEach((inventoryItem, index) => {
                        console.log('Processing inventory item:', inventoryItem);
                        // Convert inventory item to upgrade gift format
                        const gift = {
                            id: inventoryItem.id || index,
                            emoji: inventoryItem.emoji || '🎁',
                            stars: inventoryItem.price || 1,
                            name: inventoryItem.name || 'Gift'
                        };
                        
                        const giftElement = document.createElement('div');
                        giftElement.innerHTML = renderGiftCard(gift);
                        
                        // Add click event listener to the select button
                        const selectButton = giftElement.querySelector('.gift-button.select');
                        if (selectButton) {
                            selectButton.addEventListener('click', () => {
                                handleSelectGift(gift);
                            });
                        }
                        
                        grid.appendChild(giftElement);
                    });
                } else {
                    console.log('Showing desired gifts, count:', upgradeGifts.length);
                    // Show all available gifts for desired selection
                    upgradeGifts.forEach(gift => {
                        const giftElement = document.createElement('div');
                        giftElement.innerHTML = renderGiftCard(gift);
                        
                        // Add click event listener to the select button
                        const selectButton = giftElement.querySelector('.gift-button.select');
                        if (selectButton) {
                            selectButton.addEventListener('click', () => {
                                handleSelectGift(gift);
                            });
                        }
                        
                        grid.appendChild(giftElement);
                    });
                }
                
                console.log('Grid updated, children count:', grid.children.length);
                
                // Update test button visibility
                updateTestButtonVisibility();
            }

            function addTestGiftsToInventory() {
                // Add some test gifts to inventory if it's empty
                if (userInventory.length === 0) {
                    const testGifts = [
                        {
                            id: 'test1',
                            name: 'Teddy Bear',
                            price: 1,
                            image: 'https://via.placeholder.com/200x200/4e54c8/ffffff?text=🧸',
                            rarity: 'common',
                            model: 'Test',
                            backdrop: 'Gradient',
                            symbol: '⭐',
                            issued: '2024',
                            emoji: '🧸'
                        },
                        {
                            id: 'test2',
                            name: 'Gift Box',
                            price: 2,
                            image: 'https://via.placeholder.com/200x200/4e54c8/ffffff?text=🎁',
                            rarity: 'common',
                            model: 'Test',
                            backdrop: 'Gradient',
                            symbol: '⭐',
                            issued: '2024',
                            emoji: '🎁'
                        },
                        {
                            id: 'test3',
                            name: 'Birthday Cake',
                            price: 3,
                            image: 'https://via.placeholder.com/200x200/4e54c8/ffffff?text=🎂',
                            rarity: 'uncommon',
                            model: 'Test',
                            backdrop: 'Gradient',
                            symbol: '⭐',
                            issued: '2024',
                            emoji: '🎂'
                        }
                    ];
                    
                    userInventory.push(...testGifts);
                    saveToStorage();
                    updateInventory();
                    updateInventoryProfile();
                }
            }

            function initializeUpgradeSystem() {
                console.log('Initializing upgrade system...');
                
                // Check if elements exist
                const yourGiftsTab = document.getElementById('your-gifts-tab');
                const desiredTab = document.getElementById('desired-tab');
                const spinBtn = document.getElementById('upgrade-spin-btn');
                const testBtn = document.getElementById('add-test-gifts-btn');
                const balanceEl = document.getElementById('upgrade-balance');
                
                console.log('Elements found:', {
                    yourGiftsTab: !!yourGiftsTab,
                    desiredTab: !!desiredTab,
                    spinBtn: !!spinBtn,
                    testBtn: !!testBtn,
                    balanceEl: !!balanceEl
                });
                
                if (!yourGiftsTab || !desiredTab || !spinBtn || !testBtn || !balanceEl) {
                    console.error('Some upgrade elements not found!');
                    return;
                }
                
                // Set up tab switching
                yourGiftsTab.addEventListener('click', () => {
                    console.log('Switching to your gifts tab');
                    activeTab = 'yourGifts';
                    yourGiftsTab.classList.add('active');
                    desiredTab.classList.remove('active');
                    updateUpgradeGiftGrid(); // Update grid when switching tabs
                    updateTestButtonVisibility();
                });
                
                desiredTab.addEventListener('click', () => {
                    console.log('Switching to desired tab');
                    activeTab = 'desired';
                    desiredTab.classList.add('active');
                    yourGiftsTab.classList.remove('active');
                    updateUpgradeGiftGrid(); // Update grid when switching tabs
                    updateTestButtonVisibility();
                });
                
                // Set up spin button
                spinBtn.addEventListener('click', handleSpin);
                
                // Set up test gifts button
                testBtn.addEventListener('click', () => {
                    console.log('Adding test gifts...');
                    addTestGiftsToInventory();
                    updateUpgradeGiftGrid();
                    updateTestButtonVisibility();
                });
                
                // Initialize gift grid
                console.log('Updating gift grid...');
                updateUpgradeGiftGrid();
                updateTestButtonVisibility();
                
                // Update balance display
                balanceEl.textContent = currentBalance.toFixed(2);
                
                console.log('Upgrade system initialized successfully');
            }

            function updateTestButtonVisibility() {
                const testContainer = document.getElementById('test-gifts-container');
                if (testContainer) {
                    testContainer.style.display = 'block'; // Always show for debugging
                }
            }


            // --- Новые функции для профиля ---

            function updateInventoryProfile() {
                const inventoryGridProfile = document.getElementById('inventory-grid-profile');
                if (userInventory.length === 0) {
                    inventoryGridProfile.innerHTML = `
                        <div class="empty-state">
                            <p>У вас пока нет подарков.</p>
                        </div>
                    `;
                    return;
                }
                inventoryGridProfile.innerHTML = '';
                userInventory.forEach((item, index) => {
                    const rarityClass = `rarity ${item.rarity}`;
                    const inventoryItem = document.createElement('div');
                    inventoryItem.className = 'inventory-item';
                    inventoryItem.dataset.index = index;
                    inventoryItem.innerHTML = `
                        <img src="${item.image}" alt="${item.name}" class="inventory-image">
                        <div class="inventory-name">${item.name}</div>
                        <div class="${rarityClass} inventory-rarity">${capitalizeFirstLetter(item.rarity)}</div>
                    `;
                    inventoryGridProfile.appendChild(inventoryItem);
                });
            }

            function updateProfileStats() {
                document.getElementById('profile-deposit').textContent = profileStats.deposit.toFixed(2) + ' TON';
                document.getElementById('profile-cases-opened').textContent = profileStats.casesOpened;
                document.getElementById('profile-upgrades-performed').textContent = profileStats.upgradesPerformed;
            }

            function applyPromoCode(code) {
                if (code.toLowerCase() === 'zetas228') {
                    currentBalance += 10000;
                    balanceElement.textContent = currentBalance.toFixed(2);
                    // --- Увеличиваем депозит ---
                    profileStats.deposit += 10000;
                    saveToStorage();
                    showToast('Промокод zetas228 успешно активирован! Получено 10000 TON.', false);
                } else {
                    showToast('Неверный промокод.', true);
                }
            }

            // --- Новые функции для реф. программы ---

            function updateReferralStats() {
                document.getElementById('ref-total').textContent = referralStats.totalReferrals;
                document.getElementById('ref-total-earned').textContent = referralStats.totalEarned.toFixed(2) + ' TON';
                document.getElementById('ref-monthly-earned').textContent = referralStats.monthlyEarned.toFixed(2) + ' TON';
                document.getElementById('ref-link-display').textContent = userRefLink || 'https:/t.me/MagicDrop_Robot';
            }

            function createReferralCode(username) {
                // В реальном приложении это будет генерироваться на сервере
                const code = `${username}_${Math.random().toString(36).substring(2, 10)}`;
                userRefCode = code;
                userRefLink = `https:/t.me/MagicDrop_Robot/${code}`;
                saveToStorage();
                updateReferralStats();
                showToast(`Ваш промокод: ${code}`, false);
            }


            // Update upgrade chance and cost
            function updateUpgradeInfo() {
                const giftIndex = giftSelect.value;
                const targetValue = targetSelect.value;
                if (giftIndex === "" || targetValue === "" || giftIndex === targetValue) {
                    upgradeChance.textContent = "Шанс: 0%";
                    upgradeCost.textContent = "Стоимость: 0 TON";
                    upgradeBtn.disabled = true;
                    selectedGiftPreview.style.display = 'none';
                    selectedTargetPreview.style.display = 'none';
                    document.getElementById('upgrade-chance-display').textContent = 'Шанс: 0%';
                    return;
                }
                const gift = userInventory[giftIndex];
                let target;
                
                // Determine target item based on selection
                if (targetValue.startsWith('all_')) {
                    // Target is from all available items
                    const targetIndex = parseInt(targetValue.replace('all_', ''));
                    target = items[targetIndex];
                } else {
                    // Target is from user's inventory (legacy support)
                    const targetIndex = parseInt(targetValue);
                    target = userInventory[targetIndex];
                }
                
                if (!gift || !target) {
                    upgradeChance.textContent = "Шанс: 0%";
                    upgradeCost.textContent = "Стоимость: 0 TON";
                    upgradeBtn.disabled = true;
                    selectedGiftPreview.style.display = 'none';
                    selectedTargetPreview.style.display = 'none';
                    document.getElementById('upgrade-chance-display').textContent = 'Шанс: 0%';
                    return;
                }
                
                // Calculate chance based on price difference (improved system)
                const priceDiff = target.price - gift.price;
                let chance = 50; // Base chance
                
                if (priceDiff > 0) {
                    // Target is more expensive - decrease chance based on price difference
                    // More aggressive decrease for expensive targets
                    chance -= Math.min(priceDiff * 3, 45); // Max 45% decrease
                } else if (priceDiff < 0) {
                    // Target is cheaper - increase chance
                    chance += Math.min(Math.abs(priceDiff) * 2, 35); // Max 35% increase
                }
                
                // Additional rarity-based adjustments
                const rarityValues = {
                    'common': 1,
                    'uncommon': 2,
                    'rare': 3,
                    'epic': 4,
                    'legendary': 5
                };
                const giftRarityValue = rarityValues[gift.rarity];
                const targetRarityValue = rarityValues[target.rarity];
                const rarityDiff = targetRarityValue - giftRarityValue;
                
                if (rarityDiff > 0) {
                    chance -= rarityDiff * 10; // Decrease chance for higher rarity targets
                } else if (rarityDiff < 0) {
                    chance += Math.abs(rarityDiff) * 6; // Increase chance for lower rarity targets
                }
                
                // Ensure chance is between 5% and 95%
                chance = Math.max(5, Math.min(95, Math.round(chance)));
                
                // Calculate cost based on target item price
                const cost = Math.ceil(target.price * 0.25); // Reduced cost to 25% of target price
                
                upgradeChance.textContent = `Шанс: ${chance}%`;
                upgradeCost.textContent = `Стоимость: ${cost} TON`;
                document.getElementById('upgrade-chance-display').textContent = `Шанс: ${chance}%`;
                upgradeBtn.disabled = false;
                
                // Show previews
                selectedGiftPreview.style.display = 'block';
                selectedGiftPreview.innerHTML = `
                    <h3>Выбранный подарок</h3>
                    <img src="${gift.image}" alt="${gift.name}" style="width: 100px; height: 100px; border-radius: 10px; margin: 10px 0;">
                    <div class="rarity ${gift.rarity}">${capitalizeFirstLetter(gift.rarity)}</div>
                    <div>${gift.name}</div>
                    <div style="color: var(--ton); font-weight: 600;">${gift.price} TON</div>
                `;
                selectedTargetPreview.style.display = 'block';
                selectedTargetPreview.innerHTML = `
                    <h3>Цель улучшения</h3>
                    <img src="${target.image}" alt="${target.name}" style="width: 100px; height: 100px; border-radius: 10px; margin: 10px 0;">
                    <div class="rarity ${target.rarity}">${capitalizeFirstLetter(target.rarity)}</div>
                    <div>${target.name}</div>
                    <div style="color: var(--ton); font-weight: 600;">${target.price} TON</div>
                `;
            }

            // Perform upgrade
            function performUpgrade() {
                const giftIndex = giftSelect.value;
                const targetValue = targetSelect.value;
                if (giftIndex === "" || targetValue === "" || giftIndex === targetValue) {
                    showToast('Пожалуйста, выберите разные подарки для улучшения', true);
                    return;
                }
                const gift = userInventory[giftIndex];
                let target;
                
                // Determine target item based on selection
                if (targetValue.startsWith('all_')) {
                    // Target is from all available items
                    const targetIndex = parseInt(targetValue.replace('all_', ''));
                    target = items[targetIndex];
                } else {
                    // Target is from user's inventory (legacy support)
                    const targetIndex = parseInt(targetValue);
                    target = userInventory[targetIndex];
                }
                
                if (!gift || !target) {
                    showToast('Ошибка при выборе подарков', true);
                    return;
                }
                
                // Calculate cost based on target item price
                const cost = Math.ceil(target.price * 0.25);
                if (currentBalance < cost) {
                    showToast('Недостаточно средств для улучшения!', true);
                    return;
                }
                
                // Calculate chance based on price and rarity difference (same as updateUpgradeInfo)
                const priceDiff = target.price - gift.price;
                let chance = 50; // Base chance
                
                if (priceDiff > 0) {
                    chance -= Math.min(priceDiff * 2, 40);
                } else if (priceDiff < 0) {
                    chance += Math.min(Math.abs(priceDiff) * 1.5, 30);
                }
                
                const rarityValues = {
                    'common': 1,
                    'uncommon': 2,
                    'rare': 3,
                    'epic': 4,
                    'legendary': 5
                };
                const giftRarityValue = rarityValues[gift.rarity];
                const targetRarityValue = rarityValues[target.rarity];
                const rarityDiff = targetRarityValue - giftRarityValue;
                
                if (rarityDiff > 0) {
                    chance -= rarityDiff * 8;
                } else if (rarityDiff < 0) {
                    chance += Math.abs(rarityDiff) * 5;
                }
                
                chance = Math.max(5, Math.min(95, Math.round(chance)));
                
                // Deduct cost
                currentBalance -= cost;
                balanceElement.textContent = currentBalance.toFixed(2);
                
                // Determine if upgrade is successful
                const isSuccessful = Math.random() * 100 < chance;
                if (isSuccessful) {
                    // Replace gift with target
                    userInventory[giftIndex] = target;
                    showToast(`Улучшение прошло успешно! Вы получили ${target.name}`, false);
                    // Add to operations history
                    operationsHistory.unshift({
                        type: 'upgrade_success',
                        from: gift,
                        to: target,
                        cost: cost,
                        date: new Date().toLocaleString('ru-RU')
                    });
                } else {
                    // Remove gift (failed upgrade)
                    userInventory.splice(giftIndex, 1);
                    showToast('Улучшение не удалось. Подарок утерян.', true);
                    // Add to operations history
                    operationsHistory.unshift({
                        type: 'upgrade_failed',
                        from: gift,
                        cost: cost,
                        date: new Date().toLocaleString('ru-RU')
                    });
                }
                saveToStorage();
                updateInventory();
                updateUpgradeInfo();
                updateOperationsHistory();
            }

            // Load rating data
            function loadRatingData() {
                // In a real app, this would be fetched from a server
                // For demo purposes, we'll use mock data
                const ratingData = [
                    { username: 'User123', avatar: 'https://via.placeholder.com/40', balance: 150.50, earned: 500.00 },
                    { username: 'NFTCollector', avatar: 'https://via.placeholder.com/40', balance: 120.25, earned: 450.75 },
                    { username: 'CryptoKing', avatar: 'https://via.placeholder.com/40', balance: 95.00, earned: 380.00 },
                    { username: 'BearLover', avatar: 'https://via.placeholder.com/40', balance: 80.10, earned: 320.20 },
                    { username: 'GiftHunter', avatar: 'https://via.placeholder.com/40', balance: 65.75, earned: 280.50 }
                ];
                if (ratingData.length === 0) {
                    ratingTableBody.innerHTML = '';
                    noRatingData.style.display = 'block';
                    return;
                }
                noRatingData.style.display = 'none';
                ratingTableBody.innerHTML = '';
                ratingData.forEach((user, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>
                            <img src="${user.avatar}" alt="${user.username}" class="user-avatar">
                            ${user.username}
                        </td>
                        <td>${user.balance.toFixed(2)}</td> <!-- Показываем баланс с 2 знаками -->
                        <td>${user.earned.toFixed(2)}</td> <!-- Показываем заработок с 2 знаками -->
                    `;
                    ratingTableBody.appendChild(row);
                });
            }

            // Update operations history
            function updateOperationsHistory() {
                if (operationsHistory.length === 0) {
                    operationsList.innerHTML = `
                        <div class="empty-state">
                            <p>Пока нет истории операций.</p>
                        </div>
                    `;
                    return;
                }
                operationsList.innerHTML = '';
                operationsHistory.forEach(operation => {
                    const operationItem = document.createElement('div');
                    operationItem.className = 'operation-item';
                    let operationText = '';
                    let operationType = '';
                    switch (operation.type) {
                        case 'case_open':
                            operationType = 'Открытие кейса';
                            operationText = `Получен: ${operation.item.name}`;
                            break;
                        case 'upgrade_success':
                            operationType = 'Успешное улучшение';
                            operationText = `${operation.from.name} → ${operation.to.name}`;
                            break;
                        case 'upgrade_failed':
                            operationType = 'Неудачное улучшение';
                            operationText = `Потерян: ${operation.from.name}`;
                            break;
                        default:
                            operationType = 'Операция';
                            operationText = 'Неизвестная операция';
                    }
                    operationItem.innerHTML = `
                        <div>
                            <div class="operation-type">${operationType}</div>
                            <div class="operation-details">${operationText}</div>
                        </div>
                        <div class="operation-date">${operation.date}</div>
                    `;
                    operationsList.appendChild(operationItem);
                });
            }

            // Helper function to capitalize first letter
            function capitalizeFirstLetter(string) {
                return string.charAt(0).toUpperCase() + string.slice(1);
            }

            // Top up balance functionality
            topUpBtn.addEventListener('click', () => {
                topUpModal.classList.add('active');
            });
            closeModal.addEventListener('click', () => {
                topUpModal.classList.remove('active');
            });
            confirmTopUp.addEventListener('click', () => {
                 const amount = parseFloat(amountInput.value);
                 if (isNaN(amount) || amount <= 0) {
                     showToast('Пожалуйста, введите корректную сумму.', true);
                     return;
                 }
                 currentBalance += amount;
                 // --- Увеличиваем депозит ---
                 profileStats.deposit += amount;
                 balanceElement.textContent = currentBalance.toFixed(2); // Обновляем с 2 знаками
                 saveToStorage();
                 showToast(`Баланс успешно пополнен на ${amount.toFixed(2)} TON!`);
                 amountInput.value = '';
                 topUpModal.classList.remove('active');
            });

            // Close modals when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target === topUpModal) {
                    topUpModal.classList.remove('active');
                }
                if (event.target === spinModal) {
                    spinModal.classList.remove('active');
                }
            });

            skipButton.addEventListener('click', () => {
                if (isRolling) {
                    // Пропуск не реализован — просто завершаем
                    reelStrip.style.transition = 'transform 0.5s';
                    const current = parseFloat(reelStrip.style.transform.replace('translateX(', '').replace('px)', '')) || 0;
                    reelStrip.style.transform = `translateX(${Math.floor(current / 130) * 130}px)`;
                    setTimeout(() => {
                        spinModal.classList.remove('active');
                        isRolling = false;
                    }, 500);
                }
            });

            closeSpinModal.addEventListener('click', () => {
                spinModal.classList.remove('active');
                isRolling = false;
            });

            window.addEventListener('click', (e) => {
                if (e.target === spinModal) {
                    spinModal.classList.remove('active');
                    isRolling = false;
                }
            });

            // === СОБЫТИЯ ===
            document.querySelectorAll('.spin-btn').forEach((btn, idx) => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const card = btn.closest('.case-card');
                    const caseType = card.dataset.case;
                    startSpinAnimation(caseType);
                });
            });

            // Initialize spin system when upgrade page is shown
            document.addEventListener('DOMContentLoaded', () => {
                // Initialize spin system
                initSpinSystem();
            });

            // Обработчик для применения промокода
            document.getElementById('apply-promo-btn').addEventListener('click', () => {
                const code = document.getElementById('promo-input').value.trim();
                if (code) {
                    applyPromoCode(code);
                    document.getElementById('promo-input').value = ''; // Очищаем поле
                }
            });

            // Обработчик для создания промокода
            document.getElementById('create-promo-btn').addEventListener('click', () => {
                const username = document.getElementById('new-promo-input').value.trim() || 'user';
                if (username) {
                    createReferralCode(username);
                    document.getElementById('new-promo-input').value = ''; // Очищаем поле
                }
            });

            // === ИНИЦИАЛИЗАЦИЯ ===
            loadFromStorage();
            updateInventoryProfile(); // Инициализация инвентаря профиля

            // Обработчик для кнопки возврата со страницы кручения
            document.getElementById('backFromSpin').addEventListener('click', backFromSpinPage);

            // Add pulse animation for legendary items
            const style = document.createElement('style');
            style.textContent = `
                @keyframes pulse {
                    0% { background: var(--bg-gradient); }
                    50% { background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460); }
                    100% { background: var(--bg-gradient); }
                }
            `;
            document.head.appendChild(style);

            // ============= НОВАЯ ЛОГИКА АПГРЕЙДА =============
            
            // Все NFT подарки
            const allNFTGifts = [
                { id: 'witchhat', name: 'Witch Hat', price: 4, rarity: 'common', img: 'https://nft.fragment.com/gift/witchhat-28769.medium.jpg', chance: 5 },
                { id: 'bdaycandle', name: 'B-Day Candle', price: 1.22, rarity: 'common', img: 'https://nft.fragment.com/gift/bdaycandle-126281.medium.jpg', chance: 10 },
                { id: 'berrybox', name: 'Berry Box', price: 5, rarity: 'rare', img: 'https://nft.fragment.com/gift/berrybox-25500.medium.jpg', chance: 4 },
                { id: 'astralshard', name: 'Astral Shard', price: 135, rarity: 'legendary', img: 'https://nft.fragment.com/gift/astralshard-3152.medium.jpg', chance: 1 },
                { id: 'bigyear', name: 'Big Year', price: 2, rarity: 'common', img: 'https://nft.fragment.com/gift/bigyear-34582.medium.jpg', chance: 10 },
                { id: 'bowtie', name: 'Bow Tie', price: 1, rarity: 'common', img: 'https://nft.fragment.com/gift/bowtie-28769.medium.jpg', chance: 8 },
                { id: 'bunnymuffin', name: 'Bunny Muffin', price: 1, rarity: 'common', img: 'https://nft.fragment.com/gift/bunnymuffin-12885.medium.jpg', chance: 8 },
                { id: 'cookieheart', name: 'Cookie Heart', price: 1, rarity: 'common', img: 'https://nft.fragment.com/gift/cookieheart-6666.medium.jpg', chance: 8 },
                { id: 'candycane', name: 'Candy Cane', price: 1.5, rarity: 'common', img: 'https://nft.fragment.com/gift/candycane-8666.medium.jpg', chance: 7 },
                { id: 'crystalball', name: 'Crystal Ball', price: 2, rarity: 'common', img: 'https://nft.fragment.com/gift/crystalball-12686.medium.jpg', chance: 6 },
                { id: 'cupidcharm', name: 'Cupid Charm', price: 2, rarity: 'common', img: 'https://nft.fragment.com/gift/cupidcharm-9131.medium.jpg', chance: 6 },
                { id: 'deskcalendar', name: 'Desk Calendar', price: 1, rarity: 'common', img: 'https://nft.fragment.com/gift/deskcalendar-40546.medium.jpg', chance: 9 },
                { id: 'diamondring', name: 'Diamond Ring', price: 3, rarity: 'rare', img: 'https://nft.fragment.com/gift/diamondring-27070.medium.jpg', chance: 5 },
                { id: 'durovscap', name: "Durov's Cap", price: 50, rarity: 'epic', img: 'https://nft.fragment.com/gift/durovscap-1896.medium.jpg', chance: 2 },
                { id: 'easteregg', name: 'Easter Egg', price: 1, rarity: 'common', img: 'https://nft.fragment.com/gift/easteregg-103928.medium.jpg', chance: 8 },
                { id: 'eternalrose', name: 'Eternal Rose', price: 20, rarity: 'epic', img: 'https://nft.fragment.com/gift/eternalrose-22.medium.jpg', chance: 3 },
                { id: 'evileye', name: 'Evil Eye', price: 1.5, rarity: 'common', img: 'https://nft.fragment.com/gift/evileye-32715.medium.jpg', chance: 7 },
                { id: 'flyingbroom', name: 'Flying Broom', price: 2.5, rarity: 'uncommon', img: 'https://nft.fragment.com/gift/flyingbroom-22528.medium.jpg', chance: 6 },
                { id: 'freshsocks', name: 'Fresh Socks', price: 1, rarity: 'common', img: 'https://nft.fragment.com/gift/freshsocks-60569.medium.jpg', chance: 9 },
                { id: 'gemsignet', name: 'Gem Signet', price: 15, rarity: 'rare', img: 'https://nft.fragment.com/gift/gemsignet-1544.medium.jpg', chance: 4 },
                { id: 'genielamp', name: 'Genie Lamp', price: 2, rarity: 'uncommon', img: 'https://nft.fragment.com/gift/genielamp-3228.medium.jpg', chance: 6 },
                { id: 'gingercookie', name: 'Ginger Cookie', price: 1, rarity: 'common', img: 'https://nft.fragment.com/gift/gingercookie-26328.medium.jpg', chance: 8 },
                { id: 'hangingstar', name: 'Hanging Star', price: 25, rarity: 'epic', img: 'https://nft.fragment.com/gift/hangingstar-5.medium.jpg', chance: 2 },
                { id: 'heartlocket', name: 'Heart Locket', price: 10, rarity: 'rare', img: 'https://nft.fragment.com/gift/heartlocket-875.medium.jpg', chance: 4 },
                { id: 'hexpot', name: 'Hex Pot', price: 2, rarity: 'uncommon', img: 'https://nft.fragment.com/gift/hexpot-14463.medium.jpg', chance: 6 },
                { id: 'hypnolollipop', name: 'Hypno Lollipop', price: 1.5, rarity: 'common', img: 'https://nft.fragment.com/gift/hypnolollipop-18577.medium.jpg', chance: 7 },
                { id: 'inputkey', name: 'Input Key', price: 3, rarity: 'rare', img: 'https://nft.fragment.com/gift/inputkey-7756.medium.jpg', chance: 5 },
                { id: 'iongem', name: 'Ion Gem', price: 8, rarity: 'rare', img: 'https://nft.fragment.com/gift/iongem-555.medium.jpg', chance: 4 },
                { id: 'jackinthebox', name: "Jack-in-the-Box", price: 1, rarity: 'common', img: 'https://nft.fragment.com/gift/jackinthebox-59291.medium.jpg', chance: 8 },
                { id: 'jellybunny', name: 'Jelly Bunny', price: 1, rarity: 'common', img: 'https://nft.fragment.com/gift/jellybunny-31356.medium.jpg', chance: 8 },
                { id: 'jesterhat', name: 'Jester Hat', price: 30, rarity: 'epic', img: 'https://nft.fragment.com/gift/jesterhat-6.medium.jpg', chance: 2 },
                { id: 'jinglebells', name: 'Jingle Bells', price: 1, rarity: 'common', img: 'https://nft.fragment.com/gift/jinglebells-58366.medium.jpg', chance: 8 },
                { id: 'jollychimp', name: 'Jolly Chimp', price: 2, rarity: 'uncommon', img: 'https://nft.fragment.com/gift/jollychimp-22614.medium.jpg', chance: 6 },
                { id: 'joyfulbundle', name: 'Joyful Bundle', price: 3, rarity: 'rare', img: 'https://nft.fragment.com/gift/joyfulbundle-10953.medium.jpg', chance: 5 },
                { id: 'kissedfrog', name: 'Kissed Frog', price: 40, rarity: 'epic', img: 'https://nft.fragment.com/gift/kissedfrog-1141.medium.jpg', chance: 2 },
                { id: 'lightsword', name: 'Light Sword', price: 12, rarity: 'rare', img: 'https://nft.fragment.com/gift/lightsword-2165.medium.jpg', chance: 4 },
                { id: 'lolpop', name: 'Lol Pop', price: 1, rarity: 'common', img: 'https://nft.fragment.com/gift/lolpop-94355.medium.jpg', chance: 8 },
                { id: 'lootbag', name: 'Loot Bag', price: 2, rarity: 'uncommon', img: 'https://nft.fragment.com/gift/lootbag-11217.medium.jpg', chance: 6 },
                { id: 'lovecandle', name: 'Love Candle', price: 1.5, rarity: 'common', img: 'https://nft.fragment.com/gift/lovecandle-18042.medium.jpg', chance: 7 },
                { id: 'lovepotion', name: 'Love Potion', price: 50, rarity: 'epic', img: 'https://nft.fragment.com/gift/lovepotion-109.medium.jpg', chance: 2 },
                { id: 'lunarsnake', name: 'Lunar Snake', price: 3, rarity: 'rare', img: 'https://nft.fragment.com/gift/lunarsnake-56789.medium.jpg', chance: 5 },
                { id: 'lushbouquet', name: 'Lush Bouquet', price: 4, rarity: 'rare', img: 'https://nft.fragment.com/gift/lushbouquet-12386.medium.jpg', chance: 5 },
                { id: 'madpumpkin', name: 'Mad Pumpkin', price: 5, rarity: 'rare', img: 'https://nft.fragment.com/gift/madpumpkin-888.medium.jpg', chance: 4 },
                { id: 'magicpotion', name: 'Magic Potion', price: 100, rarity: 'legendary', img: 'https://nft.fragment.com/gift/magicpotion-2.medium.jpg', chance: 1 },
                { id: 'mightyarm', name: 'Mighty Arm', price: 2, rarity: 'uncommon', img: 'https://nft.fragment.com/gift/mightyarm-3109.medium.jpg', chance: 6 },
                { id: 'minioscar', name: 'Mini Oscar', price: 35, rarity: 'epic', img: 'https://nft.fragment.com/gift/minioscar-2890.medium.jpg', chance: 2 },
                { id: 'moonpendant', name: 'Moon Pendant', price: 6, rarity: 'rare', img: 'https://nft.fragment.com/gift/moonpendant-18188.medium.jpg', chance: 4 },
                { id: 'nailbracelet', name: 'Nail Bracelet', price: 1.5, rarity: 'common', img: 'https://nft.fragment.com/gift/nailbracelet-3276.medium.jpg', chance: 7 },
                { id: 'nekohelmet', name: 'Neko Helmet', price: 45, rarity: 'epic', img: 'https://nft.fragment.com/gift/nekohelmet-1244.medium.jpg', chance: 2 },
                { id: 'partysparkler', name: 'Party Sparkler', price: 1, rarity: 'common', img: 'https://nft.fragment.com/gift/partysparkler-2255.medium.jpg', chance: 8 },
                { id: 'perfumebottle', name: 'Perfume Bottle', price: 2, rarity: 'uncommon', img: 'https://nft.fragment.com/gift/perfumebottle-672.medium.jpg', chance: 6 },
                { id: 'petsnake', name: 'Pet Snake', price: 1.5, rarity: 'common', img: 'https://nft.fragment.com/gift/petsnake-28085.medium.jpg', chance: 7 },
                { id: 'plushpepe', name: 'Plush Pepe', price: 8, rarity: 'rare', img: 'https://nft.fragment.com/gift/plushpepe-2493.medium.jpg', chance: 4 },
                { id: 'preciouspeach', name: 'Precious Peach', price: 15, rarity: 'rare', img: 'https://nft.fragment.com/gift/preciouspeach-2161.medium.jpg', chance: 4 },
                { id: 'recordplayer', name: 'Record Player', price: 7, rarity: 'rare', img: 'https://nft.fragment.com/gift/recordplayer-23441.medium.jpg', chance: 4 },
                { id: 'restlessjar', name: 'Restless Jar', price: 1, rarity: 'common', img: 'https://nft.fragment.com/gift/restlessjar-41983.medium.jpg', chance: 8 },
                { id: 'santahat', name: 'Santa Hat', price: 1, rarity: 'common', img: 'https://nft.fragment.com/gift/santahat-46117.medium.jpg', chance: 8 },
                { id: 'sakuraflower', name: 'Sakura Flower', price: 2, rarity: 'uncommon', img: 'https://nft.fragment.com/gift/sakuraflower-78869.medium.jpg', chance: 6 },
                { id: 'scaredcat', name: 'Scared Cat', price: 45, rarity: 'epic', img: 'https://nft.fragment.com/gift/scaredcat-1321.medium.jpg', chance: 2 },
                { id: 'sharptongue', name: 'Sharp Tongue', price: 2, rarity: 'uncommon', img: 'https://nft.fragment.com/gift/sharptongue-4346.medium.jpg', chance: 6 },
                { id: 'signetring', name: 'Signet Ring', price: 4, rarity: 'rare', img: 'https://nft.fragment.com/gift/signetring-10272.medium.jpg', chance: 5 },
                { id: 'skullflower', name: 'Skull Flower', price: 5, rarity: 'rare', img: 'https://nft.fragment.com/gift/skullflower-10047.medium.jpg', chance: 4 },
                { id: 'skystilettos', name: 'Sky Stilettos', price: 60, rarity: 'epic', img: 'https://nft.fragment.com/gift/skystilettos-100.medium.jpg', chance: 2 },
                { id: 'sleighbell', name: 'Sleigh Bell', price: 1.5, rarity: 'common', img: 'https://nft.fragment.com/gift/sleighbell-10312.medium.jpg', chance: 7 },
                { id: 'snakebox', name: 'Snake Box', price: 1, rarity: 'common', img: 'https://nft.fragment.com/gift/snakebox-100028.medium.jpg', chance: 8 },
                { id: 'snoopdogg', name: 'Snoop Dogg', price: 200, rarity: 'legendary', img: 'https://nft.fragment.com/gift/snoopdogg-177664.medium.jpg', chance: 0.5 },
                { id: 'snowglobe', name: 'Snow Globe', price: 3, rarity: 'rare', img: 'https://nft.fragment.com/gift/snowglobe-9426.medium.jpg', chance: 5 },
                { id: 'snowmittens', name: 'Snow Mittens', price: 1, rarity: 'common', img: 'https://nft.fragment.com/gift/snowmittens-22328.medium.jpg', chance: 8 },
                { id: 'starnotepad', name: 'Star Notepad', price: 2, rarity: 'uncommon', img: 'https://nft.fragment.com/gift/starnotepad-15903.medium.jpg', chance: 6 },
                { id: 'stellarrocket', name: 'Stellar Rocket', price: 40, rarity: 'epic', img: 'https://nft.fragment.com/gift/stellarrocket-54969.medium.jpg', chance: 2 },
                { id: 'swagbag', name: 'Swag Bag', price: 6, rarity: 'rare', img: 'https://nft.fragment.com/gift/swagbag-23308.medium.jpg', chance: 4 },
                { id: 'swisswatch', name: 'Swiss Watch', price: 80, rarity: 'epic', img: 'https://nft.fragment.com/gift/swisswatch-17331.medium.jpg', chance: 1.5 },
                { id: 'tamagadget', name: 'Tama Gadget', price: 150, rarity: 'legendary', img: 'https://nft.fragment.com/gift/tamagadget-7.medium.jpg', chance: 1 },
                { id: 'tophat', name: 'Top Hat', price: 5, rarity: 'rare', img: 'https://nft.fragment.com/gift/tophat-16032.medium.jpg', chance: 4 },
                { id: 'toybear', name: 'Toy Bear', price: 2, rarity: 'uncommon', img: 'https://nft.fragment.com/gift/toybear-12595.medium.jpg', chance: 6 },
                { id: 'trappedheart', name: 'Trapped Heart', price: 8, rarity: 'rare', img: 'https://nft.fragment.com/gift/trappedheart-9568.medium.jpg', chance: 4 },
                { id: 'valentinebox', name: 'Valentine Box', price: 20, rarity: 'epic', img: 'https://nft.fragment.com/gift/valentinebox-74.medium.jpg', chance: 3 },
                { id: 'vintagecigar', name: 'Vintage Cigar', price: 15, rarity: 'rare', img: 'https://nft.fragment.com/gift/vintagecigar-1024.medium.jpg', chance: 4 },
                { id: 'voodoodoll', name: 'Voodoo Doll', price: 3, rarity: 'rare', img: 'https://nft.fragment.com/gift/voodoodoll-1327.medium.jpg', chance: 5 },
                { id: 'westsidesign', name: 'Westside Sign', price: 1, rarity: 'common', img: 'https://nft.fragment.com/gift/westsidesign-10025.medium.jpg', chance: 8 },
                { id: 'whipcupcake', name: 'Whip Cupcake', price: 2, rarity: 'uncommon', img: 'https://nft.fragment.com/gift/whipcupcake-39039.medium.jpg', chance: 6 },
                { id: 'winterwreath', name: 'Winter Wreath', price: 1.5, rarity: 'common', img: 'https://nft.fragment.com/gift/winterwreath-39544.medium.jpg', chance: 7 },
                { id: 'xmasstocking', name: 'Xmas Stocking', price: 1, rarity: 'common', img: 'https://nft.fragment.com/gift/xmasstocking-26729.medium.jpg', chance: 8 }
            ];

            // Переменные для апгрейда
            let selectedUpgradeGift = null;
            let desiredUpgradeGift = null;
            let upgradePageVisited = false;
            let isUpgradeSpinning = false;

            // Инициализация страницы апгрейда
            function initUpgradePage() {
                const winMessage = document.getElementById('win-message');
                const myGiftsIcon = document.getElementById('my-gifts-icon');
                const desiredGiftsIcon = document.getElementById('desired-gifts-icon');
                const upgradeFinalBtn = document.getElementById('upgrade-final-btn');
                
                // При заходе показываем Win на 1 секунду
                if (!upgradePageVisited) {
                    winMessage.classList.add('show');
                    setTimeout(() => {
                        winMessage.classList.remove('show');
                        upgradePageVisited = true;
                    }, 1000);
                }
                
                // Обновить шанс если есть выбранные подарки
                updateUpgradeChance();

                // Обработчики иконок
                myGiftsIcon.addEventListener('click', () => {
                    myGiftsIcon.classList.add('active');
                    desiredGiftsIcon.classList.remove('active');
                    showGiftsModal('Мои подарки', userInventory);
                });

                desiredGiftsIcon.addEventListener('click', () => {
                    desiredGiftsIcon.classList.add('active');
                    myGiftsIcon.classList.remove('active');
                    showGiftsModal('Все подарки (Желаемый)', allNFTGifts, true);
                });

                // Обработчик кнопки апгрейд
                upgradeFinalBtn.addEventListener('click', startUpgradeSpin);

                // Закрытие модального окна
                document.getElementById('close-gifts-modal').addEventListener('click', () => {
                    document.getElementById('all-gifts-modal').style.display = 'none';
                });
            }

            // Показать модальное окно с подарками
            function showGiftsModal(title, gifts, showChance = false) {
                const modal = document.getElementById('all-gifts-modal');
                const modalTitle = document.getElementById('modal-title');
                const gridContent = document.getElementById('all-gifts-grid-content');
                
                modalTitle.textContent = title;
                gridContent.innerHTML = '';
                
                gifts.forEach(gift => {
                    const giftEl = document.createElement('div');
                    giftEl.className = 'gift-modal-item';
                    giftEl.innerHTML = `
                        <img src="${gift.img || gift.image}" alt="${gift.name}">
                        <div class="gift-modal-item-name">${gift.name}</div>
                        <div class="gift-modal-item-price">⭐ ${gift.price} TON</div>
                        ${showChance ? `<div class="gift-modal-item-chance">Шанс: ${gift.chance}%</div>` : ''}
                    `;
                    
                    giftEl.addEventListener('click', () => {
                        selectGiftForUpgrade(gift, showChance);
                        modal.style.display = 'none';
                    });
                    
                    gridContent.appendChild(giftEl);
                });
                
                modal.style.display = 'block';
            }

            // Выбор подарка для апгрейда
            function selectGiftForUpgrade(gift, isDesired = false) {
                if (isDesired) {
                    desiredUpgradeGift = gift;
                    updateDesiredGiftDisplay(gift);
                } else {
                    selectedUpgradeGift = gift;
                    updateSelectedGiftDisplay(gift);
                    // Сбросить желаемый подарок при смене выбранного
                    if (desiredUpgradeGift) {
                        desiredUpgradeGift = null;
                        updateDesiredGiftDisplay(null);
                    }
                }
                
                checkUpgradeButton();
                updateUpgradeChance();
            }

            // Обновить отображение выбранного подарка
            function updateSelectedGiftDisplay(gift) {
                const img = document.getElementById('selected-gift-img');
                const name = document.getElementById('selected-gift-name');
                const stars = document.getElementById('selected-gift-stars');
                const cancelBtn = document.getElementById('cancel-selected');
                
                if (gift) {
                    img.src = gift.img || gift.image;
                    img.style.display = 'block';
                    name.textContent = gift.name;
                    stars.textContent = `⭐ ${gift.price} TON`;
                    cancelBtn.style.display = 'block';
                } else {
                    img.style.display = 'none';
                    name.textContent = '';
                    stars.textContent = '';
                    cancelBtn.style.display = 'none';
                }
                
                cancelBtn.onclick = (e) => {
                    e.stopPropagation();
                    selectedUpgradeGift = null;
                    desiredUpgradeGift = null;
                    updateSelectedGiftDisplay(null);
                    updateDesiredGiftDisplay(null);
                    checkUpgradeButton();
                    updateUpgradeChance();
                };
            }

            // Обновить отображение желаемого подарка
            function updateDesiredGiftDisplay(gift) {
                const img = document.getElementById('desired-gift-img');
                const name = document.getElementById('desired-gift-name');
                const stars = document.getElementById('desired-gift-stars');
                const cancelBtn = document.getElementById('cancel-desired');
                
                if (gift) {
                    img.src = gift.img || gift.image;
                    img.style.display = 'block';
                    name.textContent = gift.name;
                    stars.textContent = `⭐ ${gift.price} TON`;
                    cancelBtn.style.display = 'block';
                } else {
                    img.style.display = 'none';
                    name.textContent = '';
                    stars.textContent = '';
                    cancelBtn.style.display = 'none';
                }
                
                cancelBtn.onclick = (e) => {
                    e.stopPropagation();
                    desiredUpgradeGift = null;
                    updateDesiredGiftDisplay(null);
                    checkUpgradeButton();
                    updateUpgradeChance();
                };
            }

            // Проверить кнопку апгрейда
            function checkUpgradeButton() {
                if (selectedUpgradeGift && desiredUpgradeGift) {
                    document.getElementById('upgrade-final-btn').style.display = 'block';
                } else {
                    document.getElementById('upgrade-final-btn').style.display = 'none';
                }
            }
            
            function updateUpgradeChance() {
                if (!selectedUpgradeGift || !desiredUpgradeGift) return;
                const selectedPrice = selectedUpgradeGift.price || 1;
                const desiredPrice = desiredUpgradeGift.price || 1;
                // Расчет шанса: если выбранный подарок стоит 4 TON, а желаемый 8 TON, то шанс 40%
                let chance = Math.min((selectedPrice / desiredPrice) * 100, 95);
                chance = Math.max(5, Math.round(chance)); // Минимальный шанс 5%
                // ПОНИЖАЕМ ШАНС НА 25%
                chance = Math.max(5, Math.round(chance * 0.75));
                // Обновляем отображение шанса в кнопке
                const btn = document.getElementById('upgrade-final-btn');
                btn.innerHTML = `АПГРЕЙД (${chance}% шанс)`;
            }

            // Начать кручение апгрейда
            function startUpgradeSpin() {
                if (!selectedUpgradeGift || !desiredUpgradeGift) return;
                if (isUpgradeSpinning) return;
                isUpgradeSpinning = true;
                
                // Скрыть кнопку и показать колесо
                document.getElementById('upgrade-final-btn').style.display = 'none';
                const wheelContainer = document.getElementById('upgrade-wheel-container');
                wheelContainer.style.display = 'block';
                
                // Вычислить шанс на основе соотношения цен
                const selectedPrice = selectedUpgradeGift.price || 1;
                const desiredPrice = desiredUpgradeGift.price || 1;
                let winChance = Math.min((selectedPrice / desiredPrice) * 100, 95);
                winChance = Math.max(5, Math.round(winChance)); // Минимальный шанс 5%
                // ПОНИЖАЕМ ШАНС НА 25%
                winChance = Math.max(5, Math.round(winChance * 0.75));
                
                // Определить победил ли игрок (для внутреннего использования)
                const randomValue = Math.random() * 100;
                const isWin = randomValue < winChance;
                console.log(`Шанс: ${winChance}%, Результат: ${isWin ? 'ПОБЕДА' : 'ПОРАЖЕНИЕ'}`);
                
                // Создать круг со стрелкой (без результата в центре)
                createWheelWithPointer(wheelContainer, winChance, isWin);
                
                // Запустить анимацию вращения (4.5 секунды анимация + результат)
                setTimeout(() => {
                    // Добавить результат в профиль
                    if (isWin) {
                        // Заменяем выбранный подарок на желаемый
                        const indexToReplace = userInventory.findIndex(g => 
                            (g.id && g.id === selectedUpgradeGift.id) || 
                            (g.name === selectedUpgradeGift.name && g.price === selectedUpgradeGift.price)
                        );
                        if (indexToReplace !== -1) {
                            userInventory[indexToReplace] = desiredUpgradeGift;
                        }
                        // Показать сообщение о победе
                        const winMessage = document.getElementById('win-message');
                        winMessage.classList.add('show');
                        setTimeout(() => {
                            winMessage.classList.remove('show');
                        }, 2000);
                        showToast('🎉 Поздравляем! Вы выиграли ' + desiredUpgradeGift.name + '!', false);
                    } else {
                        // Если проигрыш, отнимаем выбранный подарок
                        const indexToRemove = userInventory.findIndex(g => 
                            (g.id && g.id === selectedUpgradeGift.id) || 
                            (g.name === selectedUpgradeGift.name && g.price === selectedUpgradeGift.price)
                        );
                        if (indexToRemove !== -1) {
                            userInventory.splice(indexToRemove, 1);
                        }
                        showToast('❌ Увы, вы не выиграли. Подарок утерян.', true);
                    }
                    
                    // Добавить в историю операций
                    operationsHistory.unshift({
                        type: isWin ? 'upgrade_success' : 'upgrade_failed',
                        from: selectedUpgradeGift,
                        to: isWin ? desiredUpgradeGift : null,
                        date: new Date().toLocaleString('ru-RU')
                    });
                    
                    // Обновить статистику профиля
                    profileStats.upgradesPerformed += 1;
                    
                    // Скрыть колесо и очистить выборы
                    setTimeout(() => {
                        wheelContainer.style.display = 'none';
                        selectedUpgradeGift = null;
                        desiredUpgradeGift = null;
                        checkUpgradeButton();
                        updateInventory();
                        updateOperationsHistory();
                        saveToStorage();
                        isUpgradeSpinning = false;
                        // Сбросить отображение выбранных подарков
                        updateSelectedGiftDisplay(null);
                        updateDesiredGiftDisplay(null);
                    }, 2000);
                }, 4500); // Длительность анимации + 2 секунды до смены экрана
            }
            
            // Создать круг со стрелкой
            function createWheelWithPointer(container, winChance, isWin) {
                // Очистить содержимое контейнера полностью
                container.innerHTML = '';
                const wheelHTML = `
                    <div class="wheel-wrapper">
                        <div class="wheel-circle" style="--win-percent: ${winChance}%">
                            <div class="wheel-center">
                                <div class="wheel-center-text">${winChance}%</div>
                                <div class="wheel-center-percent">Шанс</div>
                                <!-- Результат убран из центра -->
                            </div>
                        </div>
                        <div class="wheel-pointer"></div>
                        <div style="text-align: center; margin-top: 20px; font-size: 14px; color: var(--text-secondary);">
                            Выбранный: ${selectedUpgradeGift.name} (${selectedUpgradeGift.price} TON)<br>
                            Желаемый: ${desiredUpgradeGift.name} (${desiredUpgradeGift.price} TON)
                        </div>
                    </div>
                `;
                container.innerHTML = wheelHTML;
                // Анимация вращения круга
                const wheelCircle = container.querySelector('.wheel-circle');
                setTimeout(() => {
                    if (wheelCircle) {
                        // Определить финальное вращение (абсолютный рандом)
                        // Добавляем случайное количество полных оборотов (4-6) + случайный угол (0-360)
                        const baseRotation = (4 + Math.random() * 2) * 360; // 4-6 полных оборотов
                        const finalRotation = baseRotation + (Math.random() * 360); // + случайный угол
                        wheelCircle.style.transform = `rotate(${finalRotation}deg)`;
                    }
                }, 100);
            }
            
            // Создать элемент подарка
            function createGiftElement(item) {
                const giftEl = document.createElement('div');
                giftEl.className = 'upgrade-gift';
                giftEl.innerHTML = `<img src="${item.img}" alt="${item.name}">`;
                return giftEl;
            }

            // Найти когда открывается страница апгрейда
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.dataset.page === 'upgrade') {
                    item.addEventListener('click', () => {
                        initUpgradePage();
                    });
                }
            });

            // ============= КОНЕЦ НОВОЙ ЛОГИКИ АПГРЕЙДА =============
        </script>
</body>
</html>
</html>